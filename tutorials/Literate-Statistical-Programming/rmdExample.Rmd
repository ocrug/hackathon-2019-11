---
title: "Long-term Effects of Amblyopia on Functional Properties of Thalamocortical Axons in Binocular V1"
author: "Carey Y. L. Huh, Diyue (Ivy) Gu, & John P. Peach"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(cache.lazy = TRUE)
library(fieldAxonAnalysis)
library(tidyverse)
library(rPacu)
library(car)
library(magrittr)
library(boot)
library(ggpubr)
library(Rmisc)
library(lme4)
library(nlme)
library(lmerTest)
library(lmtest)
library(lemon)
library(multcomp)

dir.create(file.path('report_csv_files'), showWarnings = FALSE)
dir.create(file.path('report_figures'), showWarnings = FALSE)
```

```{r read_files, echo = FALSE, warning = FALSE}
p_cutoff <- 0.01
rPacu::driver(
  file = system.file('config', 'axon-data.csv', package = 'fieldAxonAnalysis'),
  path = system.file('extdata', package = 'fieldAxonAnalysis')
) %>%
  rPacu::sf_peak(p_cutoff = p_cutoff) %>%
  dplyr::mutate(field_id = paste(mouse_id, session_id, fov_id, sep = "_")) %>%
  dplyr::select(mouse_id, field_id, recording_id, cell_id, SF, variable, value) %>%
  dplyr::distinct() -> data_tidy
```

```{r read_dLGN_cell_count_file, echo = FALSE, warning = FALSE}
path <- system.file('extdata', package = 'fieldAxonAnalysis')
read_csv(file = file.path(path, "dLGN_cell_count.csv")) %>%
  dplyr::mutate(mouse_id = as.character(mouse_id)) -> dLGN_cell_count
```

# Experimental Animals and Other Considerations

#### Normal (control)

5 mice, 17 fields of view in binocular V1 (bV1)

Mouse 078 (Wt, F, P101), Mouse 096 (VGLUT2-Cre, F, P106), Mouse 197 (VGLUT2-Cre, M, P99), Mouse 253 (VGLUT2-Cre, F, P111), Mouse 273 (VGLUT2-Cre, F, P100)

Mouse 078 and 096: normally reared, Mouse 197, 253 and 273: littermate control to amblyopes (weaned at P19, co-housed with amb)

Depth (mean +/- SD): 144 +/- 40 microns

24% Anterior bV1, 76% Middle bV1

All data analyzed using pacu-v2, summed projection images

#### Amblyopic (MD)

6 mice, 17 fields of view in bV1

Mouse 098 (Wt, M, P132), Mouse 154 (Wt, F, P107), Mouse 194 (VGLUT2-Cre, M, P93), Mouse 195 (VGLUT2-Cre, M, P99), Mouse 243 (VGLUT2-Cre, M, P115), Mouse 270 (VGLUT2-Cre, M, P100)

Mouse 098, 154, 194, 195, 243 and 270 were monocularly deprived in Left Eye between P19 and P33

Depth (mean +/- SD): 124 +/- 31 microns

13% Anterior bV1, 87% Middle bV1

All data analyzed using pacu-v2, summed projection images

#### Included Data

Data was filtered such that only boutons with ANOVA Each p value of less than `r p_cutoff` at their peak SF was used.

#### Excluded Data

Not included: data for boutons with SF_peak of 0. Only recordings with contralateral-eye or ipsilateral-eye as viewing eye were included. Recordings with both eyes open were not included in analysis at this time. Recordings from posterior bV1 not included at this time.

#### Nomenclature

Eye_manipulation: Control vs. MD (14-day MD since P19)

Eye_group: Binocular vs. Monocular (in some cases, Monocular is further specified as Contra-only or Ipsi-only)

Eye_type: Contra vs. Ipsi (contralateral-eye vs. ipsilateral-eye response)

\pagebreak

# Summary of Sample Size

```{r odi_data, echo = FALSE, warning = FALSE}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, RMax) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(RMax = as.numeric(RMax)) %>%
  reshape2::melt(id.vars = c('eye_manipulation', 'mouse_id', 'field_id', 'cell_id', 'eye_type')) %>%
  #na.omit() %>%
  tidyr::spread(key = eye_type, value = value) %>%
  dplyr::select(-c(variable)) %>%
  dplyr::group_by(mouse_id, field_id, cell_id) %>%
  summarise_all(funs(na.omit(.)[1])) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) ~ 'Ipsi_Only',
                  is.na(ipsi) ~ 'Contra_Only',
                  TRUE ~ 'Binocular'),
                ODI = dplyr::case_when(
                  eye_group == 'Ipsi_Only' ~ as.numeric(-1),
                  eye_group == 'Contra_Only' ~ as.numeric(1),
                  eye_group == 'Binocular' ~ (contra - ipsi) / (contra + ipsi))
                ) %>%
  dplyr::select(mouse_id, field_id, cell_id, eye_manipulation, eye_group, ODI) -> odi_data
```

#### Summary of Sample Size, by Field

```{r sample_size_summary_by_field, warning = FALSE}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation, field_id) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only),
    Binocular = sum(Binocular),
    Contra_Only = sum(Contra_Only)) %>%
  dplyr::mutate(Total_Count = Ipsi_Only + Binocular + Contra_Only) %>%
  knitr::kable()
```

\pagebreak

#### Summary of Sample Size, by Animal

```{r sample_size_summary_by_animal, warning = FALSE}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation, mouse_id) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only),
    Binocular = sum(Binocular),
    Contra_Only = sum(Contra_Only)) %>%
  dplyr::mutate(Total_Count = Ipsi_Only + Binocular + Contra_Only) %>%
  knitr::kable()
```

#### Summary of Sample Size

```{r sample_size_summary, warning = FALSE}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only),
    Binocular = sum(Binocular),
    Contra_Only = sum(Contra_Only)) %>%
  dplyr::mutate(Total_Count = Ipsi_Only + Binocular + Contra_Only) %>%
  knitr::kable()
```

\pagebreak

# ODI

ODI is calculated by computing from RMax values: (contra - ipsi) / (contra + ipsi)

### All Sample, Binned Histogram of Percent of Ocular Dominance Index (ODI)

```{r odi_hist_all_sample, warning = FALSE, fig.width = 6, fig.height = 5}
odi_data %>%
  dplyr::mutate(
    bin_01 = ODI == -1,
    bin_02 = ODI > -1 & ODI < -0.6,
    bin_03 = ODI >= -0.6 & ODI < -0.2,
    bin_04 = ODI >= -0.2 & ODI < +0.2,
    bin_05 = ODI >= +0.2 & ODI < +0.6,
    bin_06 = ODI >= +0.6 & ODI < +1,
    bin_07 = ODI == 1
  ) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(
    bin_01 = sum(bin_01) / n() * 100,
    bin_02 = sum(bin_02) / n() * 100,
    bin_03 = sum(bin_03) / n() * 100,
    bin_04 = sum(bin_04) / n() * 100,
    bin_05 = sum(bin_05) / n() * 100,
    bin_06 = sum(bin_06) / n() * 100,
    bin_07 = sum(bin_07) / n() * 100
  ) %>%
  reshape2::melt(id.vars = "eye_manipulation") %>%
  dplyr::rename(odi_bin = variable, percent = value) -> odi_hist_all_sample

y_max_value <- 1.1 * max(odi_hist_all_sample$percent)

odi_hist_all_sample %>%
  ggplot(aes(x = odi_bin, y = percent)) +
  scale_x_discrete(labels = c('-1', '-0.8', '-0.4', '0', '0.4', '0.8', '1')) +
  xlab("Ocular Dominance Index") +
  ylab("Percent of Boutons, All Sample") +
  geom_bar(color = "black", stat = "identity", width = 0.7) +
  facet_wrap(~eye_manipulation, nrow = 2, scales = "free_x", strip.position = "right") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"))
rm(y_max_value)
```

\pagebreak

### Binned Histogram of Ocular Dominance Index (ODI), Binocular Only

```{r fig_odi_hist_all_sample_bin_only, warning = FALSE, fig.width = 5.5, fig.height = 4.5}
odi_data %>%
  dplyr::filter(eye_group == "Binocular") -> odi_data_bin_only
odi_data_bin_only %>%
  dplyr::mutate(
    bin_01 = ODI == -1,
    bin_02 = ODI > -1 & ODI < -0.6,
    bin_03 = ODI >= -0.6 & ODI < -0.2,
    bin_04 = ODI >= -0.2 & ODI < +0.2,
    bin_05 = ODI >= +0.2 & ODI < +0.6,
    bin_06 = ODI >= +0.6 & ODI < +1,
    bin_07 = ODI == 1
  ) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(
    bin_01 = sum(bin_01) / n() * 100,
    bin_02 = sum(bin_02) / n() * 100,
    bin_03 = sum(bin_03) / n() * 100,
    bin_04 = sum(bin_04) / n() * 100,
    bin_05 = sum(bin_05) / n() * 100,
    bin_06 = sum(bin_06) / n() * 100,
    bin_07 = sum(bin_07) / n() * 100
  ) %>%
  reshape2::melt(id.vars = c("eye_manipulation")) %>%
  dplyr::rename(odi_bin = variable, percent = value) -> odi_hist_all_sample_bin_only

y_max_value = 1.1 * max(odi_hist_all_sample_bin_only$percent)

odi_hist_all_sample_bin_only %>%
  #dplyr::mutate(odi_bin = as.numeric(odi_bin)) %>%
  ggplot(aes(x = odi_bin, y = percent, fill = eye_manipulation)) +
  scale_x_discrete(labels = c('-1', '-0.8', '-0.4', '0', '0.4', '0.8', '1')) +
  xlab("Ocular Dominance Index") +
  ylab("% Binocular Boutons") +
  #geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_bar(stat = "identity", width = 0.7, color = "black", show.legend = F, position = position_dodge(0.9)) +
  #facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "free_x", strip.position = "top") +
  scale_fill_manual(values = c("blue", "red")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/odi_hist_all_sample_bin_only.svg")
rm(y_max_value)
```

### Summary of Binned Histogram of Ocular Dominance Index (ODI), Binocular Only

```{r odi_hist_all_sample_bin_only_summary, warning = FALSE}
odi_hist_all_sample_bin_only %>%
  dplyr::select(odi_bin, eye_manipulation, percent) %>%
  knitr::kable()
```

\pagebreak

### By Field, Binned Histogram of Ocular Dominance Index (ODI), Mean +/- SEM

```{r odi_hist_by_field, warning = FALSE, fig.width = 6, fig.height = 5}
odi_data %>%
  dplyr::mutate(
    bin_01 = ODI == -1,
    bin_02 = ODI > -1 & ODI < -0.6,
    bin_03 = ODI >= -0.6 & ODI < -0.2,
    bin_04 = ODI >= -0.2 & ODI < +0.2,
    bin_05 = ODI >= +0.2 & ODI < +0.6,
    bin_06 = ODI >= +0.6 & ODI < +1,
    bin_07 = ODI == 1
  ) %>%
  dplyr::group_by(eye_manipulation, field_id) %>%
  dplyr::summarise(
    bin_01 = sum(bin_01) / n() * 100,
    bin_02 = sum(bin_02) / n() * 100,
    bin_03 = sum(bin_03) / n() * 100,
    bin_04 = sum(bin_04) / n() * 100,
    bin_05 = sum(bin_05) / n() * 100,
    bin_06 = sum(bin_06) / n() * 100,
    bin_07 = sum(bin_07) / n() * 100
  ) %>%
  reshape2::melt(id.vars = c("eye_manipulation", "field_id")) %>%
  dplyr::rename(odi_bin = variable, percent = value) -> odi_hist_by_field

odi_hist_by_field %>%
  dplyr::group_by(eye_manipulation, odi_bin) %>%
  dplyr::summarise(Mean = mean(percent), SEM = sd(percent)/sqrt(n())) -> odi_hist_by_field_summary

y_max_value <- 1.1 * max(odi_hist_by_field_summary$Mean + odi_hist_by_field_summary$SEM)

odi_hist_by_field_summary %>%
  ggplot(aes(x = odi_bin, y = Mean)) +
  scale_x_discrete(labels = c('-1', '-0.8', '-0.4', '0', '0.4', '0.8', '1')) +
  xlab("Ocular Dominance Index") +
  ylab("Percent of Boutons, by Field") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3) +
  geom_bar(color = "black", stat = "identity", width = 0.7) +
  facet_wrap(~eye_manipulation, nrow = 2, scales = "free_x", strip.position = "right") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"))
```

\pagebreak

### By Field, Binned Histogram of Ocular Dominance Index (ODI), Mean +/- SEM

```{r fig_odi_hist_by_field, warning = FALSE, fig.width = 8, fig.height = 3.5}

# TODO: fix +1 business!

odi_hist_by_field_summary %>%
  #dplyr::mutate(odi_bin = as.numeric(odi_bin)) %>%
  ggplot(aes(x = odi_bin, y = Mean+1, fill = eye_manipulation)) +
  scale_x_discrete(labels = c('-1', '-0.8', '-0.4', '0', '0.4', '0.8', '1')) +
  xlab("Ocular Dominance Index") +
  ylab("% Boutons") +
  geom_errorbar(aes(ymin = Mean+1 - SEM, ymax = Mean+1 + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_bar(stat = "identity", width = 0.7, color = "black", show.legend = F, position = position_dodge(0.9)) +
  facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "free_x", strip.position = "top") +
  scale_fill_manual(values = c("blue", "red")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  #scale_y_log10(breaks = c(1, 2, 4, 8, 16, 32, 64)) +
  #scale_y_log10() +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/odi_hist_by_field.svg")
rm(y_max_value)
```

### Binocular Only, By Field, Binned Histogram of Ocular Dominance Index (ODI), Mean +/- SEM

```{r fig_odi_hist_by_field_bin_only, warning = FALSE, fig.width = 5.5, fig.height = 4.5}
odi_data %>%
  dplyr::filter(eye_group == "Binocular") -> odi_data_bin_only
odi_data_bin_only %>%
  dplyr::mutate(
    bin_01 = ODI == -1,
    bin_02 = ODI > -1 & ODI < -0.6,
    bin_03 = ODI >= -0.6 & ODI < -0.2,
    bin_04 = ODI >= -0.2 & ODI < +0.2,
    bin_05 = ODI >= +0.2 & ODI < +0.6,
    bin_06 = ODI >= +0.6 & ODI < +1,
    bin_07 = ODI == 1
  ) %>%
  dplyr::group_by(eye_manipulation, field_id) %>%
  dplyr::summarise(
    bin_01 = sum(bin_01) / n() * 100,
    bin_02 = sum(bin_02) / n() * 100,
    bin_03 = sum(bin_03) / n() * 100,
    bin_04 = sum(bin_04) / n() * 100,
    bin_05 = sum(bin_05) / n() * 100,
    bin_06 = sum(bin_06) / n() * 100,
    bin_07 = sum(bin_07) / n() * 100
  ) %>%
  reshape2::melt(id.vars = c("eye_manipulation", "field_id")) %>%
  dplyr::rename(odi_bin = variable, percent = value) -> odi_hist_by_field_bin_only

odi_hist_by_field_bin_only %>%
  dplyr::group_by(eye_manipulation, odi_bin) %>%
  dplyr::summarise(Mean = mean(percent), SEM = sd(percent)/sqrt(n())) -> odi_hist_by_field_bin_only_summary

y_max_value = 1.1 * max(odi_hist_by_field_bin_only_summary$Mean + odi_hist_by_field_bin_only_summary$SEM)

odi_hist_by_field_bin_only_summary %>%
  #dplyr::mutate(odi_bin = as.numeric(odi_bin)) %>%
  ggplot(aes(x = odi_bin, y = Mean, fill = eye_manipulation)) +
  scale_x_discrete(labels = c('-1', '-0.8', '-0.4', '0', '0.4', '0.8', '1')) +
  xlab("Ocular Dominance Index") +
  ylab("% Binocular Boutons") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_bar(stat = "identity", width = 0.7, color = "black", show.legend = F, position = position_dodge(0.9)) +
  #facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "free_x", strip.position = "top") +
  scale_fill_manual(values = c("blue", "red")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/odi_hist_by_field_bin_only.svg")
rm(y_max_value)
```

\pagebreak

### Binocular Only, ODI Cumulative Histogram

```{r fig_odi_ecdf_bin_only, warning = FALSE, fig.width = 6, fig.height = 4}
odi_data_bin_only %>%
  ggplot(aes(ODI, colour = eye_manipulation, width = 1)) + 
  stat_ecdf(size = 1.25) +
  labs(title = "", x = "Ocular Dominance Index", y = "Fraction of Binocular Boutons") +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  scale_x_continuous(breaks = seq(-1, 1, 0.5), limits = c(-1, 1)) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA)) +
  theme(legend.title = element_blank()) 

ggsave("report_figures/odi_cumul_dist_bin_only.svg")
```

#### K-S Test to Compare ODI, Binocular Only

```{r ks_odi_bin_only, warning=FALSE}
ks <- ks.test(dplyr::filter(odi_data_bin_only, eye_manipulation == "control")$ODI,
              dplyr::filter(odi_data_bin_only, eye_manipulation == "MD")$ODI)
print(ks)
rm(ks)
```

\pagebreak

### Violin + Boxplot of ODI, Binocular Only

```{r fig_odi_viobox_bin_only, warning = FALSE, fig.width = 3, fig.height = 4.5}
odi_data_bin_only %>%
  ggplot(aes(x = eye_manipulation, y = ODI, fill = eye_manipulation)) +
  geom_violin(width = 0.7, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black", size = 0.7) +
  xlab("") +
  ylab("ODI of Binocular Boutons") +
  scale_y_continuous(breaks = seq(-1, 1, 0.5), limits = c(-1, 1.2)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/odi_viobox_bin_only.svg")
```

#### Wilcoxon Rank Sum Test to Compare Median ODI, Binocular Only

```{r odi_test_bin_only, warning = FALSE}
compare_means(ODI ~ eye_manipulation, data = odi_data_bin_only, method = "wilcox.test", p.adjust.method = "none")
```

#### Mixed Effects Model of ODI, Binocular Only

Fixed effect(s): eye_manipulation

Random effect(s): mouse_id

```{r odi_lmer_bin_only, warning = FALSE}
model_lmer = lmerTest::lmer(ODI ~ eye_manipulation + (1 | mouse_id), data = odi_data_bin_only, REML = FALSE)
print(anova(model_lmer))
rm(model_lmer)
```

\pagebreak

# Eye_group Percent Barplot (3 groups)

```{r fig_eyegroup_barplot, warning = FALSE, fig.width = 5, fig.height = 4}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only) / n() * 100,
    Binocular = sum(Binocular) / n() * 100,
    Contra_Only = sum(Contra_Only) / n() * 100) %>% 
  reshape2::melt(id.vars = "eye_manipulation") %>%
  dplyr::rename(eye_group = variable, percent = value) -> eyegroup_percent_all_sample

eyegroup_percent_all_sample %>%
  ggplot(aes(x = eye_manipulation, y = percent, fill = eye_group)) +
  geom_bar(stat = "identity", width = 0.8, color = "black") +
  xlab("") +
  ylab("% Boutons") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.5)) +
  scale_fill_manual(values = c("darkorange2", "gold", "green3"), 
                    labels = c("Ipsi Only",
                               "Binocular",
                               "Contra Only")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/eyegroup_barplot.svg")
```

#### Summary of Eye_group Count, All Sample

```{r eyegroup_count_summary_all_sample, warning = FALSE}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only),
    Binocular = sum(Binocular),
    Contra_Only = sum(Contra_Only)) %>%
  reshape2::melt(id.vars = "eye_manipulation") %>%
  dplyr::rename(eye_group = variable, count = value) %>%
  dplyr::mutate(Number_of_Boutons = count) %>%
  dplyr::select(eye_group, eye_manipulation, Number_of_Boutons) %>%
  knitr::kable()
```

#### Chi-square Test of Eye_group, All Sample

```{r eyegroup_chisq_test, warning = FALSE}
odi_data %>%
  dplyr::select(eye_manipulation, eye_group, mouse_id, field_id) -> data_temp_chisq
chisq.test(data_temp_chisq$eye_manipulation, data_temp_chisq$eye_group)
rm(data_temp_chisq)
```

Above sample size numbers apply to all analyses, except Eye_group Count analyses.

\pagebreak

### All Sample (excluding Mouse 270), Eye_group Count Histogram

For Eye_group Count analyses only, Mouse 270 is excluded due to being an outlier.

#### Summary of Eye_group Count, All Sample (excluding Mouse 270)

```{r eyegroup_count_summary_all_sample_exclude_270, warning = FALSE}
odi_data %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only),
    Binocular = sum(Binocular),
    Contra_Only = sum(Contra_Only)) %>%
  reshape2::melt(id.vars = "eye_manipulation") %>%
  dplyr::rename(eye_group = variable, count = value) -> eyegroup_count_exclude_270

eyegroup_count_exclude_270 %>%
  dplyr::mutate(Number_of_Boutons = count) %>%
  dplyr::select(eye_group, eye_manipulation, Number_of_Boutons) %>%
  knitr::kable()
```

\pagebreak

### By Field, Eye_group Count per Field Histogram, Mean +/- SEM

```{r fig_eyegroup_count_hist_by_field_linear, warning = FALSE, fig.width = 7.5, fig.height = 4.5}
odi_data %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation, mouse_id, field_id) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only),
    Binocular = sum(Binocular),
    Contra_Only = sum(Contra_Only)) %>%
  reshape2::melt(id.vars = c("eye_manipulation", "mouse_id", "field_id")) %>%
  dplyr::rename(eye_group = variable, count = value) %>%
  dplyr::mutate_at(vars(eye_manipulation), as.factor) -> eyegroup_count_by_field_exclude_270

eyegroup_count_by_field_exclude_270 %>%
  dplyr::group_by(eye_group, eye_manipulation) %>%
  dplyr::summarise(Mean = mean(count), SEM = sd(count)/sqrt(n()), N = n()) -> eyegroup_count_by_field_exclude_270_summary

y_max_value <- 1.1 * max(eyegroup_count_by_field_exclude_270$count)

eyegroup_count_by_field_exclude_270_summary %>%
  ggplot(aes(x = eye_group, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  xlab("") +
  ylab("Number of Boutons Per Field") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  scale_x_discrete(labels = c("Ipsi Only", "Binocular", "Contra Only")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = eyegroup_count_by_field_exclude_270, aes(x = eye_group, y = count), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 1.5) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/eyegroup_count_by_field_linear.svg")
rm(y_max_value)
```

\pagebreak

```{r fig_eyegroup_count_hist_by_field, warning = FALSE, fig.width = 7.5, fig.height = 4.5}
eyegroup_count_by_field_exclude_270_summary %>%
  ggplot(aes(x = eye_group, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  xlab("") +
  ylab("Number of Boutons Per Field") +
  scale_y_log10() +
  scale_fill_manual(values = c("blue", "red")) +
  scale_x_discrete(labels = c("Ipsi Only", "Binocular", "Contra Only")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = eyegroup_count_by_field_exclude_270, aes(x = eye_group, y = count), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 1.5) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/eyegroup_count_by_field.svg")
```

#### Summary of Eye_group Count per Field

```{r eyegroup_count_summary_by_field, warning = FALSE}
eyegroup_count_by_field_exclude_270_summary %>%
  dplyr::select(eye_group, eye_manipulation, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of Eye_group Count per Field, between control and MD

Fixed effect(s): eye_group, eye_manipulation, interaction

Random effect(s): mouse_id

```{r eyegroup_count_lmer_by_field, warning = FALSE}
model_lmer = lmerTest::lmer(count ~ eye_group * eye_manipulation + (1 | mouse_id), data = eyegroup_count_by_field_exclude_270, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of Eye_group Count per Field, between control and MD

```{r eyegroup_count_lmer_by_field_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

<!-- ############ TODO: check below to see if right! -->

<!-- #### Contrast Testing of Mixed Effects Model - specific post-tests for comparison between control and MD -->

<!-- Comparison is for: (1) Ipsi_Only, (2) Binocular, (3) Contra_Only groups -->

<!-- ```{r eyegroup_count_glht_by_field, warning = FALSE} -->
<!-- K_Ipsi_Only <-   matrix(c(0, 0, 0, 1, 0, 0), 1) -->
<!-- K_Binocular <-   matrix(c(0, 0, 0, 0, 1, 0), 1) -->
<!-- K_Contra_Only <- matrix(c(0, 0, 1, 0, 0, 1), 1) -->
<!-- t_Ipsi_Only <-   glht(model, linfct = K_Ipsi_Only) -->
<!-- t_Binocular <-   glht(model, linfct = K_Binocular) -->
<!-- t_Contra_Only <- glht(model, linfct = K_Contra_Only) -->
<!-- summary(t_Ipsi_Only) -->
<!-- summary(t_Binocular) -->
<!-- summary(t_Contra_Only) -->
<!-- ``` -->

#### Mixed Effects Model of Eye_group Count per Field, between control and MD (Ipsi_Only group only)

```{r eyegroup_count_lmer_by_field_ipsi, warning = FALSE}
eyegroup_count_by_field_exclude_270 %>%
  dplyr::filter(eye_group == 'Ipsi_Only') -> data_temp
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, between control and MD (Binocular group only)

```{r eyegroup_count_lmer_by_field_binocular, warning = FALSE}
eyegroup_count_by_field_exclude_270 %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, between control and MD (Contra_Only group only)

```{r eyegroup_count_lmer_by_field_contra, warning = FALSE}
eyegroup_count_by_field_exclude_270 %>%
  dplyr::filter(eye_group == 'Contra_Only') -> data_temp
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### T-test to Compare Mean of Eye_group Count per Field, between control and MD

```{r eyegroup_count_ttest_by_field, warning = FALSE}
compare_means(count ~ eye_manipulation, data = eyegroup_count_by_field_exclude_270, group.by = "eye_group", method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Mean of Eye_group Count per Field, between control and MD

```{r eyegroup_count_anova_by_field, warning = FALSE}
print(summary(aov(count ~ eye_group * eye_manipulation, data = eyegroup_count_by_field_exclude_270)))
```

\pagebreak

#### Summary of Count per Field

```{r count_summary_by_field, warning = FALSE}
odi_data %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::group_by(eye_manipulation, mouse_id, field_id) %>%
  dplyr::summarise(count = n()) -> count_by_field_exclude_270

count_by_field_exclude_270 %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(count), Median = median(count), SEM = sd(count)/sqrt(n()), N = n()) -> count_by_field_exclude_270_summary

count_by_field_exclude_270_summary %>%
  knitr::kable()
```

#### Test to Compare Count per Field

```{r count_test_by_field, warning = FALSE}
compare_means(count ~ eye_manipulation, data = count_by_field_exclude_270, method = "wilcox.test", p.adjust.method = "none")
```

#### K-S Test to Compare Count per Field

```{r count_ks_by_field, warning=FALSE}
ks <- ks.test(dplyr::filter(count_by_field_exclude_270, eye_manipulation == "control")$count,
              dplyr::filter(count_by_field_exclude_270, eye_manipulation == "MD")$count)
print(ks)
rm(ks)
```

#### Mixed Effects Model of Count per Field, between control and MD

```{r count_lmer_by_field, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation + (1 | mouse_id), data = count_by_field_exclude_270, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

\pagebreak

# Recording Conditions (1) - Number of labelled dLGN neurons

### Scatter plot of Number of labelled dLGN neurons vs. Number of Boutons Per Field

```{r fig_eyegroup_count_dLGN_cell_count, warning = FALSE, fig.width = 9, fig.height = 4.5}
dLGN_cell_count %>%
  dplyr::group_by(mouse_id) %>%
  dplyr::mutate(cell_count_sum = sum(cell_count)) %>%
  dplyr::select(mouse_id, section_id, cell_count, cell_count_sum) -> dLGN_cell_count_sum

eyegroup_count_by_field_exclude_270 %>%
  dplyr::left_join(dLGN_cell_count_sum) %>%
  dplyr::select(eye_manipulation, mouse_id, section_id, cell_count, cell_count_sum) %>% 
  na.omit() %>%
  unique() -> dLGN_cell_count_rec

eyegroup_count_by_field_exclude_270 %>%
  dplyr::left_join(dLGN_cell_count_sum) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, eye_group, count, cell_count_sum) %>%
  na.omit() %>%
  unique() -> data_with_dLGN_cell_count_rec_sum

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_dLGN_cell_count_rec_sum %>%
  ggplot(aes(x = cell_count_sum, y = count, color = eye_manipulation)) +
  stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point() +
  xlab("Number of Labelled dLGN Neurons") +
  ylab("Number of Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_count_by_field_dLGN_cell_count_rec_sum.svg")
rm(labels)
```

#### Summary of Eye_group Count, for Sample with Known Numbers of Labelled dLGN Neurons

```{r summary_eyegroup_count_dLGN_cell_count_rec, warning = FALSE}
data_with_dLGN_cell_count_rec_sum %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(count), Median = median(count), SEM = sd(count)/sqrt(n()), Number_of_fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Count per Field, for Sample with Known Numbers of Labelled dLGN Neurons (Binocular only)

```{r eyegroup_count_ttest_known_only_bin, warning = FALSE}
data_with_dLGN_cell_count_rec_sum %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(count ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Count per Field, for Sample with Known Numbers of Labelled dLGN Neurons 

```{r eyegroup_count_anova_known_only, warning = FALSE}
print(summary(aov(count ~ eye_group * eye_manipulation * cell_count_sum, data = data_with_dLGN_cell_count_rec_sum)))
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample with Known Numbers of Labelled dLGN Neurons (Binocular only)

```{r eyegroup_count_lmer_known_only_bin, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample with Known Numbers of Labelled dLGN Neurons

```{r eyegroup_count_lmer_known_only, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_group * eye_manipulation * cell_count_sum + (1 | mouse_id), data = data_with_dLGN_cell_count_rec_sum, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### By Section, dLGN Cell Count Bar plots (Mean +/- SEM), for Sample with Known Numbers of Labelled dLGN Neurons

```{r fig_dLGN_cell_count_rec, warning = FALSE, fig.width = 3, fig.height = 5}
dLGN_cell_count_rec %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(cell_count), Median = median(cell_count), SEM = sd(cell_count)/sqrt(n()), Number_of_Sections = n()) -> dLGN_cell_count_rec_summary

y_max_value <- 1.2 * max(dLGN_cell_count_rec$cell_count)

dLGN_cell_count_rec_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = dLGN_cell_count_rec, aes(x = eye_manipulation, y = cell_count), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Number of Labelled dLGN Neurons") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/dLGN_cell_count_rec.svg")
rm(y_max_value)
```

#### Summary of dLGN Cell Count, for Sample with Known Numbers of Labelled dLGN Neurons, By Section

```{r summary_dLGN_cell_count_rec, warning = FALSE}
dLGN_cell_count_rec_summary %>%
  knitr::kable()
```

#### T-test to Compare dLGN Cell Count, for Sample with Known Numbers of Labelled dLGN Neurons, By Section

```{r dLGN_cell_count_rec_ttest, warning = FALSE}
compare_means(cell_count ~ eye_manipulation, data = dLGN_cell_count_rec, method = "t.test", p.adjust.method = "none")
```

#### Mixed Effects Model of dLGN Cell Count, for Sample with Known Numbers of Labelled dLGN Neurons, By Section

Fixed effect(s): eye_manipulation

Random effect(s): mouse_id

```{r dLGN_cell_count_rec_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(cell_count ~ eye_manipulation + (1 | mouse_id), data = dLGN_cell_count_rec, REML = FALSE)
print(anova(model_lmer))
```

\pagebreak

### By Animal, dLGN Cell Count Bar plots (Mean +/- SEM), for Sample with Known Numbers of Labelled dLGN Neurons

```{r fig_dLGN_cell_count_rec_by_animal, warning = FALSE, fig.width = 3, fig.height = 5}
dLGN_cell_count_rec %>%
  dplyr::select(eye_manipulation, mouse_id, cell_count_sum) %>%
  unique() -> dLGN_cell_count_rec_by_animal

dLGN_cell_count_rec_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(cell_count_sum), Median = median(cell_count_sum), SEM = sd(cell_count_sum)/sqrt(n()), Number_of_Animals = n()) -> dLGN_cell_count_rec_summary_by_animal

y_max_value <- 1.2 * max(dLGN_cell_count_rec_by_animal$cell_count_sum)

dLGN_cell_count_rec_summary_by_animal %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = dLGN_cell_count_rec_by_animal, aes(x = eye_manipulation, y = cell_count_sum), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Number of Labelled dLGN Neurons") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/dLGN_cell_count_rec_by_animal.svg")
rm(y_max_value)
```

#### Summary of dLGN Cell Count, for Sample with Known Numbers of Labelled dLGN Neurons, By Animal

```{r summary_dLGN_cell_count_rec_by_animal, warning = FALSE}
dLGN_cell_count_rec_summary_by_animal %>%
  knitr::kable()
```

#### T-test to Compare dLGN Cell Count, for Sample with Known Numbers of Labelled dLGN Neurons, By Animal

```{r dLGN_cell_count_rec_ttest_by_animal, warning = FALSE}
compare_means(cell_count_sum ~ eye_manipulation, data = dLGN_cell_count_rec_by_animal, method = "t.test", p.adjust.method = "none")
```

\pagebreak

# Recording Conditions (2) - Depth of Recording Fields

### Scatter plot of Recording depth vs. Number of Boutons Per Field, for Sample excluding Mouse 270

```{r fig_eyegroup_count_rec_depth, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::mutate(RMax = as.numeric(RMax), rec_depth = as.numeric(recording_depth_um)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, rec_depth) %>%
  unique() -> data_rec_depth

eyegroup_count_by_field_exclude_270 %>%
  dplyr::left_join(data_rec_depth) -> data_with_rec_depth

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_rec_depth %>%
  ggplot(aes(x = rec_depth, y = count, color = eye_manipulation)) +
  stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point() +
  xlab("Recording Depth (μm)") +
  ylab("Number of Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_count_by_field_rec_depth.svg")
rm(labels)
```

#### Summary of Eye_group Count, for Sample excluding Mouse 270

```{r summary_eyegroup_count_rec_depth, warning = FALSE}
data_with_rec_depth %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(count), Median = median(count), SEM = sd(count)/sqrt(n()), Number_of_fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_ttest_rec_depth_bin, warning = FALSE}
data_with_rec_depth %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(count ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_anova_rec_depth, warning = FALSE}
print(summary(aov(count ~ eye_group * eye_manipulation * rec_depth, data = data_with_rec_depth)))
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_lmer_rec_depth_bin, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation * rec_depth + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_lmer_rec_depth, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_group * eye_manipulation * rec_depth + (1 | mouse_id), data = data_with_rec_depth, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### By Field, Recording Depth plots (Mean +/- SEM), for Sample excluding Mouse 270

```{r fig_rec_depth, warning = FALSE, fig.width = 3, fig.height = 5}
data_rec_depth %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(rec_depth), Median = median(rec_depth), SEM = sd(rec_depth)/sqrt(n()), Number_of_Fields = n()) -> rec_depth_summary

y_max_value <- 1.2 * max(data_rec_depth$rec_depth)

rec_depth_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_rec_depth, aes(x = eye_manipulation, y = rec_depth), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Recording Depth (μm)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/rec_depth.svg")
rm(y_max_value)
```

#### Summary of Recording Depth, for Sample excluding Mouse 270

```{r summary_rec_depth, warning = FALSE}
rec_depth_summary %>%
  knitr::kable()
```

#### T-test to Compare Recording Depth, for Sample excluding Mouse 270, By Field

```{r rec_depth_ttest, warning = FALSE}
compare_means(rec_depth ~ eye_manipulation, data = data_rec_depth, method = "t.test", p.adjust.method = "none")
```

#### Mixed Effects Model of Recording Depth, for Sample excluding Mouse 270, By Field

Fixed effect(s): eye_manipulation

Random effect(s): mouse_id

```{r rec_depth_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(rec_depth ~ eye_manipulation + (1 | mouse_id), data = data_rec_depth, REML = FALSE)
print(anova(model_lmer))
```

\pagebreak

### By Animal, Recording Depth, for Sample excluding Mouse 270

```{r fig_rec_depth_by_animal, warning = FALSE, fig.width = 3, fig.height = 5}
data_rec_depth %>%
  dplyr::group_by(mouse_id) %>%
  dplyr::mutate(rec_depth_ma = mean(rec_depth)) %>%
  dplyr::select(eye_manipulation, mouse_id, rec_depth_ma) %>%
  unique() -> data_rec_depth_by_animal

data_rec_depth_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(rec_depth_ma), Median = median(rec_depth_ma), SEM = sd(rec_depth_ma)/sqrt(n()), Number_of_Animals = n()) -> data_rec_depth_by_animal_summary

y_max_value <- 1.2 * max(data_rec_depth_by_animal$rec_depth_ma)

data_rec_depth_by_animal_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_rec_depth_by_animal, aes(x = eye_manipulation, y = rec_depth_ma), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Recording Depth (μm)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/rec_depth_by_animal.svg")
rm(y_max_value)
```

#### Summary of Recording Depth, for Sample excluding Mouse 270, By Animal

```{r summary_rec_depth_by_animal, warning = FALSE}
data_rec_depth_by_animal_summary %>%
  knitr::kable()
```

#### T-test to Compare Recording Depth, for Sample excluding Mouse 270, By Animal

```{r rec_depth_ttest_by_animal, warning = FALSE}
compare_means(rec_depth_ma ~ eye_manipulation, data = data_rec_depth_by_animal, method = "t.test", p.adjust.method = "none")
```


\pagebreak

# Recording Conditions (3) - Age of Mouse

### Scatter plot of Age vs. Number of Boutons Per Field, for Sample excluding Mouse 270

```{r fig_eyegroup_count_age, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::mutate(RMax = as.numeric(RMax), age = as.numeric(age_days)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, age) %>%
  unique() -> data_age

eyegroup_count_by_field_exclude_270 %>%
  dplyr::left_join(data_age) -> data_with_age

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_age %>%
  ggplot(aes(x = age, y = count, color = eye_manipulation)) +
  stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point() +
  xlab("Age (Postnatal Day)") +
  ylab("Number of Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_count_by_field_age.svg")
rm(labels)
```

#### Summary of Eye_group Count, for Sample excluding Mouse 270

```{r summary_eyegroup_count_age, warning = FALSE}
data_with_age %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(count), Median = median(count), SEM = sd(count)/sqrt(n()), Number_of_fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_ttest_age_bin, warning = FALSE}
data_with_age %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(count ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_anova_age, warning = FALSE}
print(summary(aov(count ~ eye_group * eye_manipulation * age, data = data_with_age)))
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_lmer_age_bin, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation * age + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_lmer_age, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_group * eye_manipulation * age + (1 | mouse_id), data = data_with_age, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### By Field, Age plots (Mean +/- SEM), for Sample excluding Mouse 270

```{r fig_age, warning = FALSE, fig.width = 3, fig.height = 5}
data_age %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(age), Median = median(age), SEM = sd(age)/sqrt(n()), Number_of_Fields = n()) -> age_summary

y_max_value <- 1.2 * max(data_age$age)

age_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_age, aes(x = eye_manipulation, y = age), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Age (Postnatal Day)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/age.svg")
rm(y_max_value)
```

#### Summary of Age, for Sample excluding Mouse 270

```{r summary_age, warning = FALSE}
age_summary %>%
  knitr::kable()
```

#### T-test to Compare Age, for Sample excluding Mouse 270, By Field

```{r age_ttest, warning = FALSE}
compare_means(age ~ eye_manipulation, data = data_age, method = "t.test", p.adjust.method = "none")
```

#### Mixed Effects Model of Age, for Sample excluding Mouse 270, By Field

Fixed effect(s): eye_manipulation

Random effect(s): mouse_id

```{r age_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(age ~ eye_manipulation + (1 | mouse_id), data = data_age, REML = FALSE)
print(anova(model_lmer))
```

\pagebreak

### By Animal, Age, for Sample excluding Mouse 270

```{r fig_age_by_animal, warning = FALSE, fig.width = 3, fig.height = 5}
data_age %>%
  dplyr::group_by(mouse_id) %>%
  dplyr::mutate(age_ma = mean(age)) %>%
  dplyr::select(eye_manipulation, mouse_id, age_ma) %>%
  unique() -> data_age_by_animal

data_age_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(age_ma), Median = median(age_ma), SEM = sd(age_ma)/sqrt(n()), Number_of_Animals = n()) -> data_age_by_animal_summary

y_max_value <- 1.2 * max(data_age_by_animal$age_ma)

data_age_by_animal_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_age_by_animal, aes(x = eye_manipulation, y = age_ma), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Age (Postnatal Day)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/age_by_animal.svg")
rm(y_max_value)
```

#### Summary of Age, for Sample excluding Mouse 270, By Animal

```{r summary_age_by_animal, warning = FALSE}
data_age_by_animal_summary %>%
  knitr::kable()
```

#### T-test to Compare Age, for Sample excluding Mouse 270, By Animal

```{r age_ttest_by_animal, warning = FALSE}
compare_means(age_ma ~ eye_manipulation, data = data_age_by_animal, method = "t.test", p.adjust.method = "none")
```

\pagebreak

# Recording Conditions (4) - Anterior/Posteriority of Recording Fields

### Scatter plot of Anterior/Posteriority vs. Number of Boutons Per Field, for Sample excluding Mouse 270

```{r fig_eyegroup_count_ant_post, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::mutate(RMax = as.numeric(RMax)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, ant_mid_post) %>%
  unique() -> data_ant_post

eyegroup_count_by_field_exclude_270 %>%
  dplyr::left_join(data_ant_post) -> data_with_ant_post

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_ant_post %>%
  ggplot(aes(x = ant_mid_post, y = count, color = eye_manipulation)) +
  #stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point(alpha = 0.5, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.2), size = 2) +
  xlab("Anterior/Posteriority of Recording Fields") +
  ylab("Number of Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_count_by_field_ant_post.svg")
rm(labels)
```

#### Summary of Anterior/Posteriority, for Sample excluding Mouse 270

```{r summary_eyegroup_count_ant_post, warning = FALSE}
data_ant_post %>%
  dplyr::group_by(eye_manipulation, ant_mid_post) %>%
  dplyr::summarise(Number_of_Fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_ttest_ant_post, warning = FALSE}
data_with_ant_post %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(count ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_anova_ant_post, warning = FALSE}
print(summary(aov(count ~ eye_group * eye_manipulation * ant_mid_post, data = data_with_ant_post)))
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_lmer_rec_ant_post, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation * ant_mid_post + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_lmer_ant_post, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_group * eye_manipulation * ant_mid_post + (1 | mouse_id), data = data_with_ant_post, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### Anterior/Posteriority Percent Barplot, for Sample excluding Mouse 270

```{r fig_ant_post_barplot, warning = FALSE, fig.width = 4.5, fig.height = 4}
data_ant_post %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(TotalCount = n()) %>%
  dplyr::select(eye_manipulation, TotalCount) -> data_temp

data_ant_post %>%
  dplyr::group_by(eye_manipulation, ant_mid_post) %>%
  dplyr::summarise(Count = n()) %>%
  dplyr::left_join(data_temp, by = 'eye_manipulation') %>%
  dplyr::mutate(Percent = Count / TotalCount * 100) -> data_ant_post_percent

data_ant_post_percent %>%
  ggplot(aes(x = eye_manipulation, y = Percent, fill = ant_mid_post)) +
  geom_bar(stat = "identity", width = 0.8, color = "black") +
  xlab("") +
  ylab("% Recording Fields") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.5)) +
  scale_fill_manual(values = c("darkorange2", "gold", "green3"), 
                    labels = c("Anterior",
                               "Middle",
                               "Posterior")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/rec_ant_post_barplot.svg")
```

#### Chi-square Test of Anterior/Posteriority, for Sample excluding Mouse 270

```{r ant_post_chisq_test, warning = FALSE}
data_ant_post %>%
  dplyr::select(eye_manipulation, ant_mid_post) -> data_temp_chisq
chisq.test(data_temp_chisq$eye_manipulation, data_temp_chisq$ant_mid_post)
rm(data_temp_chisq, data_temp)
```

\pagebreak

# Recording Conditions (5) - Sex of Mouse

### Scatter plot of Sex vs. Number of Boutons Per Field, for Sample excluding Mouse 270

```{r fig_eyegroup_count_sex, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::filter(mouse_id != 270) %>%
  dplyr::mutate(RMax = as.numeric(RMax)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, sex) %>%
  unique() -> data_sex

eyegroup_count_by_field_exclude_270 %>%
  dplyr::left_join(data_sex) -> data_with_sex

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_sex %>%
  ggplot(aes(x = sex, y = count, color = eye_manipulation)) +
  #stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point(alpha = 0.5, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.2), size = 2) +
  xlab("Sex") +
  ylab("Number of Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_count_by_field_sex.svg")
rm(labels)
```

#### Summary of Sex, for Sample excluding Mouse 270

```{r summary_eyegroup_count_sex, warning = FALSE}
data_sex %>%
  dplyr::group_by(eye_manipulation, sex) %>%
  dplyr::summarise(Number_of_Fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_ttest_sex, warning = FALSE}
data_with_sex %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(count ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_anova_sex, warning = FALSE}
print(summary(aov(count ~ eye_group * eye_manipulation * sex, data = data_with_sex)))
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270 (Binocular only)

```{r eyegroup_count_lmer_rec_sex, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_manipulation * sex + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Count per Field, for Sample excluding Mouse 270

```{r eyegroup_count_lmer_sex, warning = FALSE}
model_lmer2 = lmerTest::lmer(count ~ eye_group * eye_manipulation * sex + (1 | mouse_id), data = data_with_sex, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### Sex Percent Barplot, for Sample excluding Mouse 270

```{r fig_sex_barplot, warning = FALSE, fig.width = 4.5, fig.height = 4}
data_sex %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(TotalCount = n()) %>%
  dplyr::select(eye_manipulation, TotalCount) -> data_temp

data_sex %>%
  dplyr::group_by(eye_manipulation, sex) %>%
  dplyr::summarise(Count = n()) %>%
  dplyr::left_join(data_temp, by = 'eye_manipulation') %>%
  dplyr::mutate(Percent = Count / TotalCount * 100) -> data_sex_percent

data_sex_percent %>%
  ggplot(aes(x = eye_manipulation, y = Percent, fill = sex)) +
  geom_bar(stat = "identity", width = 0.8, color = "black") +
  xlab("") +
  ylab("% Recording Fields") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.5)) +
  scale_fill_manual(values = c("darkorange2", "gold"), 
                    labels = c("Female",
                               "Male")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/rec_sex_barplot.svg")
```

#### Chi-square Test of Sex, for Sample excluding Mouse 270

```{r sex_chisq_test, warning = FALSE}
data_sex %>%
  dplyr::select(eye_manipulation, sex) -> data_temp_chisq
chisq.test(data_temp_chisq$eye_manipulation, data_temp_chisq$sex)
rm(data_temp_chisq, data_temp)
```

\pagebreak

# Eye_group Percent

### All Sample, Eye_group Percent Histogram

```{r eyegroup_percent_hist_all_sample, warning = FALSE, fig.width = 7.5, fig.height = 4.5}
y_max_value <- 1.1 * max(eyegroup_percent_all_sample$percent)

eyegroup_percent_all_sample %>%
  ggplot(aes(x = eye_group, y = percent, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  xlab("") +
  ylab("Percent of Boutons, All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of Eye_group Percent Histogram, All Sample

```{r eyegroup_percent_hist_all_sample_summary, warning = FALSE}
eyegroup_percent_all_sample %>%
  dplyr::mutate(Percent_of_Boutons = percent) %>%
  dplyr::select(eye_group, eye_manipulation, Percent_of_Boutons) %>%
  knitr::kable()
```

\pagebreak

### By Field, Eye_group Percent Histogram, Mean +/- SEM

```{r eyegroup_percent_by_field, warning = FALSE, fig.width = 7.5, fig.height = 4.5}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation, mouse_id, field_id) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only) / n() * 100,
    Binocular = sum(Binocular) / n() * 100,
    Contra_Only = sum(Contra_Only)/ n() * 100) %>%
  dplyr::mutate(sum = Ipsi_Only + Binocular + Contra_Only) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, Ipsi_Only, Binocular, Contra_Only) %>%
  reshape2::melt(id.vars = c("eye_manipulation", "field_id", "mouse_id")) %>%
  dplyr::mutate(eye_group = variable, percent = value) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, eye_group, percent) -> eyegroup_percent_by_field

eyegroup_percent_by_field %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(percent), SEM = sd(percent)/sqrt(n()), N = n()) -> eyegroup_percent_by_field_summary

y_max_value <- 1.1 * max(eyegroup_percent_by_field$percent)

eyegroup_percent_by_field_summary %>%
  ggplot(aes(x = eye_group, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  xlab("") +
  ylab("% Boutons Per Field") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  scale_x_discrete(labels = c("Ipsi Only", "Binocular", "Contra Only")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = eyegroup_percent_by_field, aes(x = eye_group, y = percent), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 1.5) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/eyegroup_percent_by_field_linear.svg")
rm(y_max_value)
```

\pagebreak

```{r fig_eyegroup_percent_hist_by_field, warning = FALSE, fig.width = 7.5, fig.height = 4.5}
eyegroup_percent_by_field_summary %>%
  ggplot(aes(x = eye_group, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  xlab("") +
  ylab("% Boutons Per Field") +
  scale_y_log10() +
  scale_fill_manual(values = c("blue", "red")) +
  scale_x_discrete(labels = c("Ipsi Only", "Binocular", "Contra Only")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = eyegroup_percent_by_field, aes(x = eye_group, y = percent), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 1.5) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/eyegroup_percent_by_field.svg")
```

#### Summary of Eye_group Percent, by Field

```{r eyegroup_percent_by_field_summary, warning = FALSE}
eyegroup_percent_by_field_summary %>%
  dplyr::select(eye_group, eye_manipulation, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of Eye_group Percent, between control and MD, by Field 

Fixed effect(s): eye_group, eye_manipulation, interaction

Random effect(s): mouse_id

```{r eyegroup_percent_lmer_by_field, warning = FALSE}
model_lmer = lmerTest::lmer(percent ~ eye_group * eye_manipulation + (1 | mouse_id), data = eyegroup_percent_by_field, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of Eye_group Percent between control and MD, by Field

```{r eyegroup_percent_lmer_by_field_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of Eye_group Percent, between control and MD (Ipsi_Only group only), by Field

```{r eyegroup_percent_lmer_by_field_ipsi, warning = FALSE}
eyegroup_percent_by_field %>%
  dplyr::filter(eye_group == 'Ipsi_Only') -> data_temp
model_lmer2 = lmerTest::lmer(percent ~ eye_manipulation + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Eye_group Percent, between control and MD (Binocular group only), by Field

```{r eyegroup_percent_lmer_by_field_binocular, warning = FALSE}
eyegroup_percent_by_field %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(percent ~ eye_manipulation + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Eye_group Percent, between control and MD (Contra_Only group only), by Field

```{r eyegroup_percent_lmer_by_field_contra, warning = FALSE}
eyegroup_percent_by_field %>%
  dplyr::filter(eye_group == 'Contra_Only') -> data_temp
model_lmer2 = lmerTest::lmer(percent ~ eye_manipulation + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare Mean of Eye_group Percent, between control and MD, by Field

```{r eyegroup_percent_ttest_by_field, warning = FALSE}
compare_means(percent ~ eye_manipulation, data = eyegroup_percent_by_field, group.by = "eye_group", method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Mean of Eye_group Percent, between control and MD, by Field

```{r eyegroup_percent_anova_by_field, warning = FALSE}
print(summary(aov(percent ~ as.factor(eye_group) * as.factor(eye_manipulation), data = eyegroup_percent_by_field)))
```

\pagebreak

### By Animal, Eye_group Percent Histogram, Mean +/- SEM

```{r eyegroup_percent_by_animal, warning = FALSE, fig.width = 7.5, fig.height = 4.5}
odi_data %>%
  dplyr::mutate(
    Ipsi_Only = ODI == -1,
    Binocular = ODI > -1 & ODI < +1,
    Contra_Only = ODI == 1) %>%
  dplyr::group_by(eye_manipulation, mouse_id) %>%
  dplyr::summarise(
    Ipsi_Only = sum(Ipsi_Only) / n() * 100,
    Binocular = sum(Binocular) / n() * 100,
    Contra_Only = sum(Contra_Only)/ n() * 100) %>%
  dplyr::mutate(sum = Ipsi_Only + Binocular + Contra_Only) %>%
  dplyr::select(eye_manipulation, mouse_id, Ipsi_Only, Binocular, Contra_Only) %>%
  reshape2::melt(id.vars = c("eye_manipulation", "mouse_id")) %>%
  dplyr::mutate(eye_group = variable, percent = value) %>%
  dplyr::select(eye_manipulation, mouse_id, eye_group, percent) -> eyegroup_percent_by_animal

eyegroup_percent_by_animal %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(percent), SEM = sd(percent)/sqrt(n()), N = n()) -> eyegroup_percent_by_animal_summary

y_max_value <- 1.1 * max(eyegroup_percent_by_animal$percent)

eyegroup_percent_by_animal_summary %>%
  ggplot(aes(x = eye_group, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  xlab("") +
  ylab("Percent of Boutons, by Animal") +
  scale_y_log10() +
  #scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) +
  geom_jitter(data = eyegroup_percent_by_animal, aes(x = eye_group, y = percent), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank()) 
rm(y_max_value)
```

#### Summary of Eye_group Percent, by Animal

```{r eyegroup_percent_by_animal_summary, warning = FALSE}
eyegroup_percent_by_animal_summary %>%
  dplyr::select(eye_group, eye_manipulation, Mean, SEM, N) %>%
  knitr::kable()
```

#### T-test to Compare Mean of Eye_group Percent, between control and MD, by Animal

```{r eyegroup_percent_ttest_by_animal, warning = FALSE}
compare_means(percent ~ eye_manipulation, data = eyegroup_percent_by_animal, group.by = "eye_group", method = "t.test", p.adjust.method = "none")
```

\pagebreak

#### 2-way ANOVA to Compare Mean of Eye_group Percent, between control and MD, by Animal

```{r eyegroup_percent_anova_by_animal, warning = FALSE}
print(summary(aov(percent ~ as.factor(eye_group) * as.factor(eye_manipulation), data = eyegroup_percent_by_animal)))
```

\pagebreak

# Recording Conditions (1) - Depth of Recording Fields

### Scatter plot of Recording depth vs. Eye_group Percent Per Field

```{r fig_eyegroup_percent_rec_depth_2, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(RMax = as.numeric(RMax), rec_depth = as.numeric(recording_depth_um)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, rec_depth) %>%
  unique() -> data_rec_depth

eyegroup_percent_by_field %>%
  dplyr::left_join(data_rec_depth) -> data_with_rec_depth

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_rec_depth %>%
  ggplot(aes(x = rec_depth, y = percent, color = eye_manipulation)) +
  stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point() +
  xlab("Recording Depth (μm)") +
  ylab("% Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_percent_by_field_rec_depth_2.svg")
rm(labels)
```

#### Summary of Eye_group Pecent

```{r summary_eyegroup_percent_rec_depth_2, warning = FALSE}
data_with_rec_depth %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(percent), Median = median(percent), SEM = sd(percent)/sqrt(n()), Number_of_fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Percent per Field (Binocular only)

```{r eyegroup_percent_ttest_rec_depth_bin_2, warning = FALSE}
data_with_rec_depth %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(percent ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Percent per Field

```{r eyegroup_percent_anova_rec_depth_2, warning = FALSE}
print(summary(aov(percent ~ eye_group * eye_manipulation * rec_depth, data = data_with_rec_depth)))
```

#### Mixed Effects Model of Eye_group Percent per Field (Binocular only)

```{r eyegroup_percent_lmer_rec_depth_bin_2, warning = FALSE}
model_lmer2 = lmerTest::lmer(percent ~ eye_manipulation * rec_depth + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Percent per Field

```{r eyegroup_percent_lmer_rec_depth_2, warning = FALSE}
model_lmer2 = lmerTest::lmer(percent ~ eye_group * eye_manipulation * rec_depth + (1 | mouse_id), data = data_with_rec_depth, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### By Field, Recording Depth plots (Mean +/- SEM)

```{r fig_rec_depth_2, warning = FALSE, fig.width = 3, fig.height = 5}
data_rec_depth %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(rec_depth), Median = median(rec_depth), SEM = sd(rec_depth)/sqrt(n()), Number_of_Fields = n()) -> rec_depth_summary

y_max_value <- 1.2 * max(data_rec_depth$rec_depth)

rec_depth_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_rec_depth, aes(x = eye_manipulation, y = rec_depth), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Recording Depth (μm)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/rec_depth_2.svg")
rm(y_max_value)
```

#### Summary of Recording Depth

```{r summary_rec_depth_2, warning = FALSE}
rec_depth_summary %>%
  knitr::kable()
```

#### T-test to Compare Recording Depth, By Field

```{r rec_depth_ttest_2, warning = FALSE}
compare_means(rec_depth ~ eye_manipulation, data = data_rec_depth, method = "t.test", p.adjust.method = "none")
```

#### Mixed Effects Model of Recording Depth, By Field

Fixed effect(s): eye_manipulation

Random effect(s): mouse_id

```{r rec_depth_lmer_2, warning = FALSE}
model_lmer = lmerTest::lmer(rec_depth ~ eye_manipulation + (1 | mouse_id), data = data_rec_depth, REML = FALSE)
print(anova(model_lmer))
```

\pagebreak

### By Animal, Recording Depth

```{r fig_rec_depth_by_animal_2, warning = FALSE, fig.width = 3, fig.height = 5}
data_rec_depth %>%
  dplyr::group_by(mouse_id) %>%
  dplyr::mutate(rec_depth_ma = mean(rec_depth)) %>%
  dplyr::select(eye_manipulation, mouse_id, rec_depth_ma) %>%
  unique() -> data_rec_depth_by_animal

data_rec_depth_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(rec_depth_ma), Median = median(rec_depth_ma), SEM = sd(rec_depth_ma)/sqrt(n()), Number_of_Animals = n()) -> data_rec_depth_by_animal_summary

y_max_value <- 1.2 * max(data_rec_depth_by_animal$rec_depth_ma)

data_rec_depth_by_animal_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_rec_depth_by_animal, aes(x = eye_manipulation, y = rec_depth_ma), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Recording Depth (μm)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/rec_depth_by_animal_2.svg")
rm(y_max_value)
```

#### Summary of Recording Depth, By Animal

```{r summary_rec_depth_by_animal_2, warning = FALSE}
data_rec_depth_by_animal_summary %>%
  knitr::kable()
```

#### T-test to Compare Recording Depth, By Animal

```{r rec_depth_ttest_by_animal_2, warning = FALSE}
compare_means(rec_depth_ma ~ eye_manipulation, data = data_rec_depth_by_animal, method = "t.test", p.adjust.method = "none")
```

\pagebreak

# Recording Conditions (2) - Age of Mouse

### Scatter plot of Age vs. Eye_group Percent per Field

```{r fig_eyegroup_percent_age_2, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(RMax = as.numeric(RMax), age = as.numeric(age_days)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, age) %>%
  unique() -> data_age

eyegroup_percent_by_field %>%
  dplyr::left_join(data_age) -> data_with_age

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_age %>%
  ggplot(aes(x = age, y = percent, color = eye_manipulation)) +
  stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point() +
  xlab("Age (Postnatal Day)") +
  ylab("% Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_percent_by_field_age_2.svg")
rm(labels)
```

#### Summary of Eye_group Percent

```{r summary_eyegroup_percent_age_2, warning = FALSE}
data_with_age %>%
  dplyr::group_by(eye_manipulation, eye_group) %>%
  dplyr::summarise(Mean = mean(percent), Median = median(percent), SEM = sd(percent)/sqrt(n()), Number_of_fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Percent per Field (Binocular only)

```{r eyegroup_percent_ttest_age_bin_2, warning = FALSE}
data_with_age %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(percent ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Percent per Field

```{r eyegroup_percent_anova_age_2, warning = FALSE}
print(summary(aov(percent ~ eye_group * eye_manipulation * age, data = data_with_age)))
```

#### Mixed Effects Model of Eye_group Percent per Field (Binocular only)

```{r eyegroup_percent_lmer_age_bin_2, warning = FALSE}
model_lmer2 = lmerTest::lmer(percent ~ eye_manipulation * age + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Percent per Field

```{r eyegroup_percent_lmer_age_2, warning = FALSE}
model_lmer2 = lmerTest::lmer(percent ~ eye_group * eye_manipulation * age + (1 | mouse_id), data = data_with_age, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### By Field, Age plots (Mean +/- SEM)

```{r fig_age_2, warning = FALSE, fig.width = 3, fig.height = 5}
data_age %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(age), Median = median(age), SEM = sd(age)/sqrt(n()), Number_of_Fields = n()) -> age_summary

y_max_value <- 1.2 * max(data_age$age)

age_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_age, aes(x = eye_manipulation, y = age), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Age (Postnatal Day)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/age_2.svg")
rm(y_max_value)
```

#### Summary of Age

```{r summary_age_2, warning = FALSE}
age_summary %>%
  knitr::kable()
```

#### T-test to Compare Age, By Field

```{r age_ttest_2, warning = FALSE}
compare_means(age ~ eye_manipulation, data = data_age, method = "t.test", p.adjust.method = "none")
```

#### Mixed Effects Model of Age, By Field

Fixed effect(s): eye_manipulation

Random effect(s): mouse_id

```{r age_lmer_2, warning = FALSE}
model_lmer = lmerTest::lmer(age ~ eye_manipulation + (1 | mouse_id), data = data_age, REML = FALSE)
print(anova(model_lmer))
```

\pagebreak

### By Animal, Age

```{r fig_age_by_animal_2, warning = FALSE, fig.width = 3, fig.height = 5}
data_age %>%
  dplyr::group_by(mouse_id) %>%
  dplyr::mutate(age_ma = mean(age)) %>%
  dplyr::select(eye_manipulation, mouse_id, age_ma) %>%
  unique() -> data_age_by_animal

data_age_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean = mean(age_ma), Median = median(age_ma), SEM = sd(age_ma)/sqrt(n()), Number_of_Animals = n()) -> data_age_by_animal_summary

y_max_value <- 1.2 * max(data_age_by_animal$age_ma)

data_age_by_animal_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, position = position_dodge(0.9)) +
  geom_jitter(data = data_age_by_animal, aes(x = eye_manipulation, y = age_ma), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  xlab("") +
  ylab("Age (Postnatal Day)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/age_by_animal_2.svg")
rm(y_max_value)
```

#### Summary of Age, By Animal

```{r summary_age_by_animal_2, warning = FALSE}
data_age_by_animal_summary %>%
  knitr::kable()
```

#### T-test to Compare Age, By Animal

```{r age_ttest_by_animal_2, warning = FALSE}
compare_means(age_ma ~ eye_manipulation, data = data_age_by_animal, method = "t.test", p.adjust.method = "none")
```

\pagebreak

# Recording Conditions (3) - Sex of Mouse

### Scatter plot of Sex vs. Eye_group Percent

```{r fig_eyegroup_percent_sex_2, warning = FALSE, fig.width = 9, fig.height = 4.5}
data_tidy %>% 
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(RMax = as.numeric(RMax)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, sex) %>%
  unique() -> data_sex

eyegroup_percent_by_field %>%
  dplyr::left_join(data_sex) -> data_with_sex

labels <- c(Ipsi_Only = "Ipsi Only", Binocular = "Binocular", Contra_Only = "Contra Only")

data_with_sex %>%
  ggplot(aes(x = sex, y = percent, color = eye_manipulation)) +
  #stat_smooth(method = "lm", se = TRUE, level = 0.95, alpha = 0.3) +
  geom_point(alpha = 0.5, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.2), size = 2) +
  xlab("Sex") +
  ylab("% Boutons Per Field") +
  facet_rep_wrap(~eye_group, nrow = 1, strip.position = "top", repeat.tick.labels = FALSE, labeller = labeller(eye_group = labels)) +
  scale_y_log10() +
  scale_color_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/eyegroup_percent_by_field_sex_2.svg")
rm(labels)
```

#### Summary of Sex

```{r summary_eyegroup_percent_sex_2, warning = FALSE}
data_sex %>%
  dplyr::group_by(eye_manipulation, sex) %>%
  dplyr::summarise(Number_of_Fields = n()) %>%
  knitr::kable()
```

\pagebreak

#### T-test to Compare Eye_group Percent per Field (Binocular only)

```{r eyegroup_percent_ttest_sex_2, warning = FALSE}
data_with_sex %>%
  dplyr::filter(eye_group == 'Binocular') -> data_temp2
compare_means(percent ~ eye_manipulation, data = data_temp2, method = "t.test", p.adjust.method = "none")
```

#### 2-way ANOVA to Compare Eye_group Percent per Field

```{r eyegroup_percent_anova_sex_2, warning = FALSE}
print(summary(aov(percent ~ eye_group * eye_manipulation * sex, data = data_with_sex)))
```

#### Mixed Effects Model of Eye_group Percent per Field (Binocular only)

```{r eyegroup_percent_lmer_rec_sex_2, warning = FALSE}
model_lmer2 = lmerTest::lmer(percent ~ eye_manipulation * sex + (1 | mouse_id), data = data_temp2, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2)
```

#### Mixed Effects Model of Eye_group Percent per Field

```{r eyegroup_percent_lmer_sex_2, warning = FALSE}
model_lmer2 = lmerTest::lmer(percent ~ eye_group * eye_manipulation * sex + (1 | mouse_id), data = data_with_sex, REML = FALSE)
print(anova(model_lmer2))
rm(model_lmer2, data_temp2)
```

\pagebreak

### Sex Percent Barplot

```{r fig_sex_barplot_2, warning = FALSE, fig.width = 4.5, fig.height = 4}
data_sex %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(TotalCount = n()) %>%
  dplyr::select(eye_manipulation, TotalCount) -> data_temp

data_sex %>%
  dplyr::group_by(eye_manipulation, sex) %>%
  dplyr::summarise(Count = n()) %>%
  dplyr::left_join(data_temp, by = 'eye_manipulation') %>%
  dplyr::mutate(Percent = Count / TotalCount * 100) -> data_sex_percent

data_sex_percent %>%
  ggplot(aes(x = eye_manipulation, y = Percent, fill = sex)) +
  geom_bar(stat = "identity", width = 0.8, color = "black") +
  xlab("") +
  ylab("% Recording Fields") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.5)) +
  scale_fill_manual(values = c("darkorange2", "gold"), 
                    labels = c("Female",
                               "Male")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/rec_sex_barplot_2.svg")
```

#### Chi-square Test of Sex

```{r sex_chisq_test_2, warning = FALSE}
data_sex %>%
  dplyr::select(eye_manipulation, sex) -> data_temp_chisq
chisq.test(data_temp_chisq$eye_manipulation, data_temp_chisq$sex)
rm(data_temp_chisq, data_temp)
```

\pagebreak

# SF_peak Cumulative Distribution by Eye_group

```{r sf_peak_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, SF) %>%
  tidyr::spread(key = eye_type, value = SF) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = SF.Peak, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, SF.Peak)) -> sf_peak_eyegroups_2
# IMPORTANT: sf_peak_eyegroups_2 has double entries (rows) for binocular group
```

### Summary of SF_peak by Eye_group, All Sample

```{r sf_peak_eyegroups_summary, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(Median = median(SF.Peak), Mean = mean(SF.Peak), N = n()) %>%
  knitr::kable()
```

\pagebreak

### All Sample, SF_peak Cumulative Histogram by Eye_group (control vs. MD panels)

```{r sf_peak_eyegroups_ecdf, warning = FALSE, fig.width = 8, fig.height = 6}
sf_peak_eyegroups_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  ggplot(aes(SF.Peak, colour = Eye_group_type)) + 
  stat_ecdf() +
  labs(title = "", x = "Peak Spatial Frequency (cpd)", y = "Proportion of Boutons, All Sample") +
  facet_wrap(~Eye_manipulation, nrow = 2, scales = "free_x", strip.position = "right") +
  scale_color_manual(values = c("cyan","dark red","dark green","blue")) +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

### All Sample, SF_peak Cumulative Histogram by Eye_group (Eye_group panels)

```{r sf_peak_eyegroups_ecdf_2, warning = FALSE, fig.width = 8, fig.height = 6}
sf_peak_eyegroups_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  ggplot(aes(SF.Peak, colour = Eye_manipulation)) + 
  stat_ecdf() +
  labs(title = "", x = "Peak Spatial Frequency (cpd)", y = "Proportion of Boutons, All Sample") +
  facet_wrap(~Eye_group_type, nrow = 2, scales = "free_x", strip.position = "right") +
  scale_color_manual(values = c("blue", "red")) +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

# SF_peak Probability Distribution

### All Sample, SF_peak Probability Distribution by Eye_group (4 groups)

```{r sf_peak_percent_table_all_sample, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, SF.Peak) %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type, SF.Peak) %>%
  dplyr::summarise(count = n()) -> sf_count_table_all_sample

sf_count_table_all_sample %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::mutate(percent = prop.table(count) * 100) %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::mutate(sum = sum(percent)) -> sf_percent_table_all_sample
```

```{r sf_peak_pdf_all_sample, warning = FALSE, fig.width = 13, fig.height = 8}
sf_percent_table_all_sample %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  ggplot(aes(x = SF.Peak, y = percent, color = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group_type, nrow = 2, scales = "free_y", repeat.tick.labels = "all", strip.position = "top") +
  scale_color_manual(values = c("blue", "red")) +
  geom_point(size = 3) +
  stat_smooth(method = "loess") +
  labs(x = "Peak Spatial Frequency (cpd)", y = "% Boutons, All Sample") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

### By Animal, SF_peak Probability Distribution by Eye_group (4 groups), Mean +/- SEM

```{r sf_peak_percent_table_by_animal, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  dplyr::select(-c(field_id, cell_id)) %>%
  dplyr::group_by(Eye_manipulation, mouse_id, Eye_group_type, SF.Peak) %>%
  dplyr::summarise(count = n()) -> sf_count_table_by_animal

sf_count_table_by_animal %>%
  tidyr::expand(mouse_id, Eye_group_type, SF.Peak) %>%
  dplyr::left_join(dplyr::distinct(sf_count_table_by_animal, mouse_id, Eye_manipulation)) %>%
  dplyr::left_join(sf_count_table_by_animal) %>%
  dplyr::mutate(count = ifelse(is.na(count), 0, count)) %>%
  dplyr::group_by(mouse_id, Eye_group_type) %>%
  dplyr::mutate(percent =  prop.table(count) * 100) %>%
  dplyr::mutate(percent = ifelse(is.na(percent), 0, percent)) %>%
  dplyr::group_by(mouse_id, Eye_group_type) %>%
  dplyr::mutate(sum = sum(percent)) %>%
  dplyr::filter(sum == 100) -> sf_percent_table_by_animal
```

```{r fig_sf_peak_pdf_by_animal, warning = FALSE, fig.width = 17, fig.height = 4.5}
sf_percent_table_by_animal %>%
  dplyr::group_by(Eye_manipulation, Eye_group_type, SF.Peak) %>%
  dplyr::summarise(Mean = mean(percent), SEM = sd(percent)/sqrt(n()), N = n()) -> sf_percent_table_by_animal_summary

labels <- c(Binocular_contra = "Binocular Contra", Binocular_ipsi = "Binocular Ipsi", Monocular_contra = "Contra Only", Monocular_ipsi = "Ipsi Only")
y_max_value <- 1.2 * max(sf_percent_table_by_animal_summary$Mean + sf_percent_table_by_animal_summary$SEM)
y_min_value <- 0

sf_percent_table_by_animal_summary %>%
  ggplot(aes(x = SF.Peak, y = Mean, color = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group_type, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_color_manual(values = c("blue", "red")) +
  geom_point(size = 3) +
  stat_smooth(method = "loess") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.05, size = 0.75) +
  labs(x = "Peak Spatial Frequency (cpd)", y = "% Boutons") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  #scale_y_log10(breaks = c(0.05, 0.1, 0.2, 0.4)) +
  theme_classic(base_size = 20) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_pdf_by_animal.svg")
rm(labels, y_max_value, y_min_value)
```

\pagebreak

# SF_peak Median by Eye_group

### All Sample, SF_peak Median by Eye_group, Median +/- Error of Median

To estimate error of median, we used formula of: sqrt(pi/2) * SE of Mean.

```{r sf_peak_median_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
sf_peak_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), mean = mean(SF.Peak), se = sd(SF.Peak)/sqrt(n()), 
                   Median = median(SF.Peak), SE_Median = sqrt(pi/2) * se) -> sf_peak_median_eyegroup_all_sample_summary
# to calculate se of mean (for estimating error of median), we calculated mean, se but didn't use later

y_max_value <- 1.1 * max(sf_peak_median_eyegroup_all_sample_summary$Median + sf_peak_median_eyegroup_all_sample_summary$SE_Median)

sf_peak_median_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Median, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Median - SE_Median, ymax = Median + SE_Median), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Median Peak SF (cpd), All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All Sample, SF_peak Violin + Boxplot by Eye_group

```{r sf_peak_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
sf_peak_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = SF.Peak, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_fill_manual(values = c("blue", "red")) +
  xlab("") +
  ylab("Peak SF (cpd), All Sample") + 
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

#### Summary of SF_peak Median by Eye_group, All Sample

```{r sf_peak_median_eyegroup_all_sample_summary, warning = FALSE}
sf_peak_median_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Median, SE_Median, N) %>%
  knitr::kable()
```

#### Wilcoxon Test, to Compare SF_peak Median by Eye_group, between control and MD, All Sample

```{r sf_peak_median_wilcox_all_sample}
sf_peak_eyegroups_2 %>%
  dplyr::select(-c(mouse_id)) -> data_temp
compare_means(SF.Peak ~ Eye_manipulation, data = data_temp, group.by = c("Eye_group", "Eye_type"), method = "wilcox.test", p.adjust.method = "none")
rm(data_temp)
```

\pagebreak

### By Animal, SF_peak Median by Eye_group, Mean +/- SEM

For each animal, median SF peak was calculated, then mean and SEM were calculated of by-animal values and plotted.

```{r sf_peak_median_eyegroup_by_animal, warning = FALSE, fig.width = 8, fig.height = 5}
sf_peak_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type, mouse_id) %>%
  dplyr::summarise(Median = median(SF.Peak)) -> sf_peak_median_eyegroup_by_animal

sf_peak_median_eyegroup_by_animal%>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(Median), SEM = sd(Median)/sqrt(n())) -> sf_peak_median_eyegroup_by_animal_summary

y_max_value <- 1.1 * max(sf_peak_median_eyegroup_by_animal$Median)

sf_peak_median_eyegroup_by_animal_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Median Peak SF (cpd), by Animal") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  geom_jitter(data = sf_peak_median_eyegroup_by_animal, aes(x = Eye_type, y = Median), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of SF_peak Median by Eye_group, by Animal

```{r sf_peak_median_eyegroup_by_animal_summary, warning = FALSE}
sf_peak_median_eyegroup_by_animal_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

#### T-test to Compare SF_peak Medians by Eye_group, between control and MD, by Animal

```{r sf_peak_median_ttest_by_animal, warning = FALSE}
compare_means(Median ~ Eye_manipulation, data = sf_peak_median_eyegroup_by_animal, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare SF_peak Medians by Eye_group, between control and MD, by Animal

```{r sf_peak_median_anova_by_animal, warning = FALSE}
print(summary(aov(Median ~ Eye_manipulation * Eye_group * Eye_type, data = sf_peak_median_eyegroup_by_animal)))
```

\pagebreak

# SF_peak Mean by Eye_group

### All sample, SF_peak Mean by Eye_group, Mean +/- SEM

```{r sf_peak_mean_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
sf_peak_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(SF.Peak), SEM = sd(SF.Peak)/sqrt(n())) -> sf_peak_mean_eyegroup_all_sample_summary
  
y_max_value <- 1.1 * max(sf_peak_mean_eyegroup_all_sample_summary$Mean + sf_peak_mean_eyegroup_all_sample_summary$SEM)

sf_peak_mean_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Mean Peak SF (cpd), All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of SF_peak Mean by Eye_group, All Sample

```{r sf_peak_mean_eyegroup_all_sample_summary, warning = FALSE}
sf_peak_mean_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of SF_peak Mean by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r sf_peak_mean_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(SF.Peak ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = sf_peak_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of SF_peak Mean by Eye_group, between control and MD, All Sample

```{r sf_peak_mean_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of SF_peak Mean by Eye_group, between control and MD (Binocular only), All Sample

```{r sf_peak_mean_lmer_all_sample_binocular, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Peak ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Mixed Effects SF_peak Mean by Eye_group, between control and MD (Monocular only), All Sample

```{r sf_peak_mean_lmer_all_sample_monocular, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Peak ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF_peak Mean by Eye_group, between control and MD (Contra only), All Sample

```{r sf_peak_mean_lmer_all_sample_contra, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Peak ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF_peak Mean by Eye_group, between control and MD (Ipsi only), All Sample

```{r sf_peak_mean_lmer_all_sample_ipsi, warning = FALSE}
sf_peak_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Peak ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare SF_peak Mean by Eye_group, between control and MD, All Sample

```{r sf_peak_mean_ttest_all_sample, warning = FALSE}
compare_means(SF.Peak ~ Eye_manipulation, data =  sf_peak_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare SF_peak Mean by Eye_group, between control and MD, All Sample

```{r sf_peak_mean_anova_all_sample, warning = FALSE}
print(summary(aov(SF.Peak ~ Eye_manipulation * Eye_group * Eye_type, data = sf_peak_eyegroups_2)))
```

\pagebreak

### All Sample, SF_peak, Binocular vs. Monocular, Mean +/- SEM, Control Only

```{r fig_sfpeak_binmon_ctrl, warning = FALSE, fig.width = 2.5, fig.height = 4}
sf_peak_eyegroups_2 %>%
  dplyr::filter(Eye_manipulation == 'control') %>%
  dplyr::group_by(Eye_manipulation, Eye_group) -> sf_peak_eyegroups_ctrl

sf_peak_eyegroups_ctrl %>%
  dplyr::summarise(Mean = mean(SF.Peak), Median = median(SF.Peak), SEM = sd(SF.Peak)/sqrt(n()), N = n()) -> sf_peak_binmon_ctrl_summary
  
y_max_value <- 0.305

sf_peak_binmon_ctrl_summary %>%
  ggplot(aes(x = Eye_group, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  #facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Mean Peak SF (cpd)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_x_discrete(limit = c("Binocular", "Monocular"), labels = c("Bin", "Mon")) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(legend.position = "none")

ggsave("report_figures/sf_peak_bin_mon_ctrl_only.svg")
rm(y_max_value)
```

#### Summary of SF_peak, Binocular vs. Monocular, Control Only

```{r sfpeak_binmon_ctrl_summary, warning = FALSE}
sf_peak_binmon_ctrl_summary %>%
  knitr::kable()
```

#### Mixed Effects Model of SF_peak, Binocular vs. Monocular, Control Only

Fixed effect(s): Eye_group

Random effect(s): mouse_id

```{r sfpeak_binmon_ctrl_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(SF.Peak ~ Eye_group + (1 | mouse_id), data = sf_peak_eyegroups_ctrl, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of SF_peak, Binocular vs. Monocular, Control Only

```{r sfpeak_binmon_ctrl_lmer_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

### By Animal, SF_peak Mean by Eye_group, Mean +/- SEM

For each animal, mean SF peak was calculated, then mean and SEM were calculated of by-animal values and plotted.

```{r fig_sf_peak_mean_eyegroup_by_animal, warning = FALSE, fig.width = 8.5, fig.height = 5}
sf_peak_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type, mouse_id) %>%
  dplyr::summarise(Mean_SF_Peak = mean(SF.Peak)) -> sf_peak_mean_eyegroup_by_animal

sf_peak_mean_eyegroup_by_animal%>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(Mean_SF_Peak), SEM = sd(Mean_SF_Peak)/sqrt(n())) -> sf_peak_mean_eyegroup_by_animal_summary

y_max_value <- 0.415

sf_peak_mean_eyegroup_by_animal_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Mean Peak SF (cpd)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  #scale_y_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = sf_peak_mean_eyegroup_by_animal, aes(x = Eye_type, y = Mean_SF_Peak), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/sf_peak_mean_eyegroup_by_animal.svg")
rm(y_max_value)
```

\pagebreak

#### Summary of SF_peak Mean by Eye_group, by Animal

```{r sf_peak_mean_eyegroup_by_animal_summary, warning = FALSE}
sf_peak_mean_eyegroup_by_animal_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

#### T-test to Compare SF_peak Means by Eye_group, between control and MD, by Animal

```{r sf_peak_mean_ttest_by_animal, warning = FALSE}
compare_means(Mean_SF_Peak ~ Eye_manipulation, data = sf_peak_mean_eyegroup_by_animal, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

\pagebreak

#### 3-way ANOVA to Compare SF_peak Means by Eye_group, between control and MD, by Animal

```{r sf_peak_mean_anova_by_animal, warning = FALSE}
print(summary(aov(Mean_SF_Peak ~ Eye_manipulation * Eye_group * Eye_type, data = sf_peak_mean_eyegroup_by_animal)))
#aov_temp <- aov(Mean_SF_Peak ~ Eye_manipulation * Eye_group * Eye_type, data = sf_peak_mean_eyegroup_by_animal)
#print(summary(aov_temp))
#rm(aov_temp)
```

\pagebreak

# SF_pref Cumulative Distribution by Eye_group

Be aware that SF tuning curve fits were not checked - SF.Pref values may not match with SF.Peak.

```{r sf_pref_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(SF.Pref = as.numeric(SF.Pref)) %>%
  dplyr::filter(SF.Pref >= 0.03 & SF.Pref <= 0.96) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, SF.Pref) %>%
  tidyr::spread(key = eye_type, value = SF.Pref) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = SF.Pref, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, SF.Pref)) -> sf_pref_eyegroups_2
# IMPORTANT: sf_pref_eyegroups_2 has double entries (rows) for binocular group
```

### Summary of SF_pref by Eye_group, All Sample

```{r sf_pref_eyegroups_summary, warning = FALSE}
sf_pref_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(Median = median(SF.Pref), Mean = mean(SF.Pref), N = n()) %>%
  knitr::kable()
```

\pagebreak

### All Sample, SF_pref Cumulative Histogram by Eye_group (control vs. MD panels)

```{r sf_pref_eyegroups_ecdf, warning = FALSE, fig.width = 8, fig.height = 6}
sf_pref_eyegroups_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  ggplot(aes(SF.Pref, colour = Eye_group_type)) + 
  stat_ecdf() +
  labs(title = "", x = "Pref Spatial Frequency (cpd)", y = "Proportion of Boutons, All Sample") +
  facet_wrap(~Eye_manipulation, nrow = 2, scales = "free_x", strip.position = "right") +
  scale_color_manual(values = c("cyan","dark red","dark green","blue")) +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

### All Sample, SF_pref Cumulative Histogram by Eye_group (Eye_group panels)

```{r sf_pref_eyegroups_ecdf_2, warning = FALSE, fig.width = 8, fig.height = 6}
sf_pref_eyegroups_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  ggplot(aes(SF.Pref, colour = Eye_manipulation)) + 
  stat_ecdf() +
  labs(title = "", x = "Pref Spatial Frequency (cpd)", y = "Proportion of Boutons, All Sample") +
  facet_wrap(~Eye_group_type, nrow = 2, scales = "free_x", strip.position = "right") +
  scale_color_manual(values = c("blue", "red")) +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

# SF_pref Median by Eye_group

### All Sample, SF_pref Median by Eye_group, Median +/- Error of Median

To estimate error of median, we used formula of: sqrt(pi/2) * SE of Mean.

```{r sf_pref_median_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
sf_pref_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), mean = mean(SF.Pref), se = sd(SF.Pref)/sqrt(n()), 
                   Median = median(SF.Pref), SE_Median = sqrt(pi/2) * se) -> sf_pref_median_eyegroup_all_sample_summary
# to calculate se of mean (for estimating error of median), we calculated mean, se but didn't use later

y_max_value <- 1.1 * max(sf_pref_median_eyegroup_all_sample_summary$Median + sf_pref_median_eyegroup_all_sample_summary$SE_Median)

sf_pref_median_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Median, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Median - SE_Median, ymax = Median + SE_Median), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Median Pref SF (cpd), All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All Sample, SF_pref Violin + Boxplot by Eye_group

```{r sf_pref_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
sf_pref_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = SF.Pref, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_fill_manual(values = c("blue", "red")) +
  xlab("") +
  ylab("Pref SF (cpd), All Sample") + 
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

\pagebreak

#### Summary of SF_pref Median by Eye_group, All Sample

```{r sf_pref_median_eyegroup_all_sample_summary, warning = FALSE}
sf_pref_median_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Median, SE_Median, N) %>%
  knitr::kable()
```

#### Wilcoxon Test, to Compare SF_pref Median by Eye_group, between control and MD, All Sample

```{r sf_pref_median_wilcox_all_sample}
sf_pref_eyegroups_2 %>%
  dplyr::select(-c(mouse_id)) -> data_temp
compare_means(SF.Pref ~ Eye_manipulation, data = data_temp, group.by = c("Eye_group", "Eye_type"), method = "wilcox.test", p.adjust.method = "none")
rm(data_temp)
```

\pagebreak

### By Animal, SF_pref Median by Eye_group, Mean +/- SEM

For each animal, median SF pref was calculated, then mean and SEM were calculated of by-animal values and plotted.

```{r sf_pref_median_eyegroup_by_animal, warning = FALSE, fig.width = 8, fig.height = 5}
sf_pref_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type, mouse_id) %>%
  dplyr::summarise(Median = median(SF.Pref)) -> sf_pref_median_eyegroup_by_animal

sf_pref_median_eyegroup_by_animal%>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(Median), SEM = sd(Median)/sqrt(n())) -> sf_pref_median_eyegroup_by_animal_summary

y_max_value <- 1.1 * max(sf_pref_median_eyegroup_by_animal$Median)

sf_pref_median_eyegroup_by_animal_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Median Pref SF (cpd), by Animal") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  geom_jitter(data = sf_pref_median_eyegroup_by_animal, aes(x = Eye_type, y = Median), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of SF_pref Median by Eye_group, by Animal

```{r sf_pref_median_eyegroup_by_animal_summary, warning = FALSE}
sf_pref_median_eyegroup_by_animal_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

#### T-test to Compare SF_pref Medians by Eye_group, between control and MD, by Animal

```{r sf_pref_median_ttest_by_animal, warning = FALSE}
compare_means(Median ~ Eye_manipulation, data = sf_pref_median_eyegroup_by_animal, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

\pagebreak

#### 3-way ANOVA to Compare SF_pref Medians by Eye_group, between control and MD, by Animal

```{r sf_pref_median_anova_by_animal, warning = FALSE}
print(summary(aov(Median ~ Eye_manipulation * Eye_group * Eye_type, data = sf_pref_median_eyegroup_by_animal)))
```

\pagebreak

# SF_pref Mean by Eye_group

### All sample, SF_pref Mean by Eye_group, Mean +/- SEM

```{r sf_pref_mean_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
sf_pref_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(SF.Pref), SEM = sd(SF.Pref)/sqrt(n())) -> sf_pref_mean_eyegroup_all_sample_summary
  
y_max_value <- 1.1 * max(sf_pref_mean_eyegroup_all_sample_summary$Mean + sf_pref_mean_eyegroup_all_sample_summary$SEM)

sf_pref_mean_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Mean Pref SF (cpd), All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of SF_pref Mean by Eye_group, All Sample

```{r sf_pref_mean_eyegroup_all_sample_summary, warning = FALSE}
sf_pref_mean_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of SF_pref Mean by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r sf_pref_mean_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(SF.Pref ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = sf_pref_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of SF_pref Mean by Eye_group, between control and MD, All Sample

```{r sf_pref_mean_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of SF_pref Mean by Eye_group, between control and MD (Binocular only), All Sample

```{r sf_pref_mean_lmer_all_sample_binocular, warning = FALSE}
sf_pref_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Pref ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Mixed Effects SF_pref Mean by Eye_group, between control and MD (Monocular only), All Sample

```{r sf_pref_mean_lmer_all_sample_monocular, warning = FALSE}
sf_pref_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Pref ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF_pref Mean by Eye_group, between control and MD (Contra only), All Sample

```{r sf_pref_mean_lmer_all_sample_contra, warning = FALSE}
sf_pref_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Pref ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF_pref Mean by Eye_group, between control and MD (Ipsi only), All Sample

```{r sf_pref_mean_lmer_all_sample_ipsi, warning = FALSE}
sf_pref_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(SF.Pref ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare SF_pref Mean by Eye_group, between control and MD, All Sample

```{r sf_pref_mean_ttest_all_sample, warning = FALSE}
compare_means(SF.Pref ~ Eye_manipulation, data =  sf_pref_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare SF_pref Mean by Eye_group, between control and MD, All Sample

```{r sf_pref_mean_anova_all_sample, warning = FALSE}
print(summary(aov(SF.Pref ~ Eye_manipulation * Eye_group * Eye_type, data = sf_pref_eyegroups_2)))
```

\pagebreak

### By Animal, SF_pref Mean by Eye_group, Mean +/- SEM

For each animal, mean SF pref was calculated, then mean and SEM were calculated of by-animal values and plotted.

```{r fig_sf_pref_mean_eyegroup_by_animal, warning = FALSE, fig.width = 8.5, fig.height = 5}
sf_pref_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type, mouse_id) %>%
  dplyr::summarise(Mean_SF_Pref = mean(SF.Pref)) -> sf_pref_mean_eyegroup_by_animal

sf_pref_mean_eyegroup_by_animal%>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(Mean_SF_Pref), SEM = sd(Mean_SF_Pref)/sqrt(n())) -> sf_pref_mean_eyegroup_by_animal_summary

y_max_value <- 1.1 * max(sf_pref_mean_eyegroup_by_animal$Mean_SF_Pref)

sf_pref_mean_eyegroup_by_animal_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Mean Pref SF (cpd)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  #scale_y_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = sf_pref_mean_eyegroup_by_animal, aes(x = Eye_type, y = Mean_SF_Pref), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/sf_pref_mean_eyegroup_by_animal.svg")
rm(y_max_value)
```

\pagebreak

#### Summary of SF_pref Mean by Eye_group, by Animal

```{r sf_pref_mean_eyegroup_by_animal_summary, warning = FALSE}
sf_pref_mean_eyegroup_by_animal_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

#### T-test to Compare SF_pref Means by Eye_group, between control and MD, by Animal

```{r sf_pref_mean_ttest_by_animal, warning = FALSE}
compare_means(Mean_SF_Pref ~ Eye_manipulation, data = sf_pref_mean_eyegroup_by_animal, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

\pagebreak

#### 3-way ANOVA to Compare SF_pref Means by Eye_group, between control and MD, by Animal

```{r sf_pref_mean_anova_by_animal, warning = FALSE}
print(summary(aov(Mean_SF_Pref ~ Eye_manipulation * Eye_group * Eye_type, data = sf_pref_mean_eyegroup_by_animal)))
```

\pagebreak

# RMax

```{r rmax_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(rmax = as.numeric(RMax)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, rmax) %>%
  tidyr::spread(key = eye_type, value = rmax) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = rmax, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, rmax)) -> rmax_eyegroups_2
```

### All Sample, RMax by Eye_group, Mean +/- SEM

```{r rmax_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
rmax_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(rmax), Median = median(rmax), SEM = sd(rmax)/sqrt(n())) -> rmax_eyegroup_all_sample_summary
  
y_max_value <- 1.1 * max(rmax_eyegroup_all_sample_summary$Mean + rmax_eyegroup_all_sample_summary$SEM)

rmax_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("RMax, All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All sample, RMax Violin + Boxplot by Eye_group

```{r rmax_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
y_max_value <- 1.1 * max(rmax_eyegroups_2$rmax)

rmax_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = rmax, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") + 
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_log10(expand = c(0.01, 0.01), limits = c(0.01, y_max_value)) +
  xlab("") +
  ylab("RMax, All Sample") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of RMax by Eye_group, All Sample

```{r rmax_eyegroup_all_sample_summary, warning = FALSE}
rmax_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of RMax by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r rmax_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = rmax_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of RMax by Eye_group, between control and MD, All Sample

```{r rmax_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of Rmax by Eye_group, between control and MD (Binocular only), All Sample

```{r rmax_lmer_all_sample_binocular, warning = FALSE}
rmax_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of RMax by Eye_group, between control and MD (Monocular only), All Sample

```{r rmax_lmer_all_sample_monocular, warning = FALSE}
rmax_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model RMax by Eye_group, between control and MD (Contra only), All Sample

```{r rmax_lmer_all_sample_contra, warning = FALSE}
rmax_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of RMax by Eye_group, between control and MD (Ipsi only), All Sample

```{r rmax_lmer_all_sample_ipsi, warning = FALSE}
rmax_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer)
```

\pagebreak

#### T-test to Compare RMax by Eye_group, between control and MD, All Sample

```{r rmax_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(rmax ~ Eye_manipulation, data =  rmax_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare RMax by Eye_group, between control and MD, All Sample

```{r rmax_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(rmax ~ Eye_manipulation * Eye_group * Eye_type, data = rmax_eyegroups_2)))
```

\pagebreak

### All Sample, RMax, Binocular vs. Monocular, Mean +/- SEM

```{r fig_rmax_binmon_all_sample, warning = FALSE, fig.width = 6, fig.height = 4.5}
rmax_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group) %>%
  dplyr::summarise(Mean = mean(rmax), Median = median(rmax), SEM = sd(rmax)/sqrt(n()), N = n()) -> rmax_binmon_all_sample_summary
  
y_max_value <- 1.2 * max(rmax_binmon_all_sample_summary$Mean + rmax_binmon_all_sample_summary$SEM)

rmax_binmon_all_sample_summary %>%
  ggplot(aes(x = Eye_group, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  #facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Response Amplitude (ΔF / F0)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/rmax_bin_mon_all_sample.svg")
rm(y_max_value)
```

#### Summary of RMax, Binocular vs. Monocular, All Sample

```{r rmax_binmon_all_sample_summary, warning = FALSE}
rmax_binmon_all_sample_summary %>%
  knitr::kable()
```

#### Mixed Effects Model of RMax, Binocular vs. Monocular, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, interaction

Random effect(s): mouse_id

```{r rmax_lmer_binmon_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = rmax_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of RMax, Binocular vs. Monocular, between control and MD, All Sample

```{r rmax_eyegroup_lmer_binmon_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

# OSI

OSI values between 0 and 1 are considered.

```{r osi_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(osi = as.numeric(OSI)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, osi) %>%
  tidyr::spread(key = eye_type, value = osi) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = osi, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::filter(osi <= 1 & osi >= 0) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, osi)) -> osi_eyegroups_2
```

### All Sample, OSI by Eye_group, Mean +/- SEM

```{r osi_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
osi_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(osi), Median = median(osi), SEM = sd(osi)/sqrt(n())) -> osi_eyegroup_all_sample_summary
  
y_max_value <- 1.1

osi_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("OSI, All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All sample, OSI Violin + Boxplot by Eye_group

```{r osi_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
y_max_value <- 1.1

osi_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = osi, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  xlab("") +
  ylab("OSI, All Sample") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of OSI by Eye_group, All Sample

```{r osi_eyegroup_all_sample_summary, warning = FALSE}
osi_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of OSI by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r osi_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(osi ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = osi_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of OSI by Eye_group, between control and MD, All Sample

```{r osi_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of OSI by Eye_group, between control and MD (Binocular only), All Sample

```{r osi_lmer_all_sample_binocular, warning = FALSE}
osi_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(osi ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of OSI by Eye_group, between control and MD (Monocular only), All Sample

```{r osi_lmer_all_sample_monocular, warning = FALSE}
osi_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(osi ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of OSI by Eye_group, between control and MD (Contra only), All Sample

```{r osi_lmer_all_sample_contra, warning = FALSE}
osi_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(osi ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of OSI by Eye_group, between control and MD (Ipsi only), All Sample

```{r osi_lmer_all_sample_ipsi, warning = FALSE}
osi_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(osi ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare OSI by Eye_group, between control and MD, All Sample

```{r osi_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(osi ~ Eye_manipulation, data =  osi_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare OSI by Eye_group, between control and MD, All Sample

```{r osi_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(osi ~ Eye_manipulation * Eye_group * Eye_type, data = osi_eyegroups_2)))
```

\pagebreak

# DSI

DSI values between 0 and 1 are considered.

```{r dsi_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(dsi = as.numeric(DSI)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, dsi) %>%
  tidyr::spread(key = eye_type, value = dsi) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = dsi, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::filter(dsi <= 1 & dsi >= 0) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, dsi)) -> dsi_eyegroups_2
```

### All Sample, DSI by Eye_group, Mean +/- SEM

```{r dsi_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
dsi_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(dsi), Median = median(dsi), SEM = sd(dsi)/sqrt(n())) -> dsi_eyegroup_all_sample_summary
  
y_max_value <- 1.1

dsi_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("DSI, All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All sample, DSI Violin + Boxplot by Eye_group

```{r dsi_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
y_max_value <- 1.1

dsi_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = dsi, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  xlab("") +
  ylab("DSI, All Sample") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of DSI by Eye_group, All Sample

```{r dsi_eyegroup_all_sample_summary, warning = FALSE}
dsi_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of DSI by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r dsi_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(dsi ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = dsi_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of DSI by Eye_group, between control and MD, All Sample

```{r dsi_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of DSI by Eye_group, between control and MD (Binocular only), All Sample

```{r dsi_lmer_all_sample_binocular, warning = FALSE}
dsi_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(dsi ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of DSI by Eye_group, between control and MD (Monocular only), All Sample

```{r dsi_lmer_all_sample_monocular, warning = FALSE}
dsi_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(dsi ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of DSI by Eye_group, between control and MD (Contra only), All Sample

```{r dsi_lmer_all_sample_contra, warning = FALSE}
dsi_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(dsi ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of DSI by Eye_group, between control and MD (Ipsi only), All Sample

```{r dsi_lmer_all_sample_ipsi, warning = FALSE}
dsi_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(dsi ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare DSI by Eye_group, between control and MD, All Sample

```{r dsi_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(dsi ~ Eye_manipulation, data =  dsi_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare DSI by Eye_group, between control and MD, All Sample

```{r dsi_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(dsi ~ Eye_manipulation * Eye_group * Eye_type, data = dsi_eyegroups_2)))
```

\pagebreak

# CV

CV values between 0 and 1 are considered.

```{r cv_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(cv = as.numeric(CV)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, cv) %>%
  tidyr::spread(key = eye_type, value = cv) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = cv, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::filter(cv <= 1 & cv >= 0) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, cv)) -> cv_eyegroups_2
```

### All Sample, CV by Eye_group, Mean +/- SEM

```{r cv_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
cv_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(cv), Median = median(cv), SEM = sd(cv)/sqrt(n())) -> cv_eyegroup_all_sample_summary
  
y_max_value <- 1.1

cv_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("CV, All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All sample, CV Violin + Boxplot by Eye_group

```{r cv_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
y_max_value <- 1.1

cv_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = cv, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  xlab("") +
  ylab("CV, All Sample") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of CV by Eye_group, All Sample

```{r cv_eyegroup_all_sample_summary, warning = FALSE}
cv_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of CV by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r cv_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(cv ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = cv_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of CV by Eye_group, between control and MD, All Sample

```{r cv_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of CV by Eye_group, between control and MD (Binocular only), All Sample

```{r cv_lmer_all_sample_binocular, warning = FALSE}
cv_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(cv ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of CV by Eye_group, between control and MD (Monocular only), All Sample

```{r cv_lmer_all_sample_monocular, warning = FALSE}
cv_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(cv ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of CV by Eye_group, between control and MD (Contra only), All Sample

```{r cv_lmer_all_sample_contra, warning = FALSE}
cv_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(cv ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of CV by Eye_group, between control and MD (Ipsi only), All Sample

```{r cv_lmer_all_sample_ipsi, warning = FALSE}
cv_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(cv ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare CV by Eye_group, between control and MD, All Sample

```{r cv_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(cv ~ Eye_manipulation, data =  cv_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare CV by Eye_group, between control and MD, All Sample

```{r cv_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(cv ~ Eye_manipulation * Eye_group * Eye_type, data = cv_eyegroups_2)))
```

\pagebreak

# DCV

DCV values between 0 and 1 are considered.

```{r dcv_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(dcv = as.numeric(DCV)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, dcv) %>%
  tidyr::spread(key = eye_type, value = dcv) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = dcv, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::filter(dcv <= 1 & dcv >= 0) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, dcv)) -> dcv_eyegroups_2
```

### All Sample, DCV by Eye_group, Mean +/- SEM

```{r dcv_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
dcv_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(dcv), Median = median(dcv), SEM = sd(dcv)/sqrt(n())) -> dcv_eyegroup_all_sample_summary
  
y_max_value <- 1.1

dcv_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("DCV, All Sample") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

### All sample, DCV Violin + Boxplot by Eye_group

```{r dcv_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
y_max_value <- 1.1

dcv_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = dcv, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  xlab("") +
  ylab("DCV, All Sample") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
rm(y_max_value)
```

#### Summary of DCV by Eye_group, All Sample

```{r dcv_eyegroup_all_sample_summary, warning = FALSE}
dcv_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of DCV by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r dcv_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(dcv ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = dcv_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of DCV by Eye_group, between control and MD, All Sample

```{r dcv_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of DCV by Eye_group, between control and MD (Binocular only), All Sample

```{r dcv_lmer_all_sample_binocular, warning = FALSE}
dcv_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(dcv ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of DCV by Eye_group, between control and MD (Monocular only), All Sample

```{r dcv_lmer_all_sample_monocular, warning = FALSE}
dcv_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(dcv ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of DCV by Eye_group, between control and MD (Contra only), All Sample

```{r dcv_lmer_all_sample_contra, warning = FALSE}
dcv_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(dcv ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of DCV by Eye_group, between control and MD (Ipsi only), All Sample

```{r dcv_lmer_all_sample_ipsi, warning = FALSE}
dcv_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(dcv ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare DCV by Eye_group, between control and MD, All Sample

```{r dcv_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(dcv ~ Eye_manipulation, data =  dcv_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare DCV by Eye_group, between control and MD, All Sample

```{r dcv_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(dcv ~ Eye_manipulation * Eye_group * Eye_type, data = dcv_eyegroups_2)))
```

\pagebreak

# Sigma (orientation tuning width)

Sigma values between 0 and 500 are considered.

```{r sigma_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(sigma = as.numeric(Sigma)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, sigma) %>%
  tidyr::spread(key = eye_type, value = sigma) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = sigma, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::filter(sigma <= 500 & sigma >= 0) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, sigma)) -> sigma_eyegroups_2
```

### All Sample, Sigma by Eye_group, Mean +/- SEM

```{r sigma_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
sigma_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(sigma), Median = median(sigma), SEM = sd(sigma)/sqrt(n())) -> sigma_eyegroup_all_sample_summary

sigma_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("Sigma, All Sample") +
  scale_y_continuous() +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

### All sample, Sigma Violin + Boxplot by Eye_group

```{r sigma_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
sigma_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = sigma, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_continuous() +
  xlab("") +
  ylab("Sigma, All Sample") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

#### Summary of Sigma by Eye_group, All Sample

```{r sigma_eyegroup_all_sample_summary, warning = FALSE}
sigma_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of Sigma by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r sigma_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(sigma ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = sigma_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of Sigma by Eye_group, between control and MD, All Sample

```{r sigma_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of Sigma by Eye_group, between control and MD (Binocular only), All Sample

```{r sigma_lmer_all_sample_binocular, warning = FALSE}
sigma_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(sigma ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Sigma by Eye_group, between control and MD (Monocular only), All Sample

```{r sigma_lmer_all_sample_monocular, warning = FALSE}
sigma_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(sigma ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Sigma by Eye_group, between control and MD (Contra only), All Sample

```{r sigma_lmer_all_sample_contra, warning = FALSE}
sigma_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(sigma ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of Sigma by Eye_group, between control and MD (Ipsi only), All Sample

```{r sigma_lmer_all_sample_ipsi, warning = FALSE}
sigma_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(sigma ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare Sigma by Eye_group, between control and MD, All Sample

```{r sigma_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(sigma ~ Eye_manipulation, data =  sigma_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare Sigma by Eye_group, between control and MD, All Sample

```{r sigma_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(sigma ~ Eye_manipulation * Eye_group * Eye_type, data = sigma_eyegroups_2)))
```

\pagebreak

# SF.Bandwidth (SF tuning width)

SF.Bandwidth values between 0 and 6 are considered.

```{r sfbw_eyegroups, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(sfbw = as.numeric(SF.Bandwidth)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, sfbw) %>%
  tidyr::spread(key = eye_type, value = sfbw) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = sfbw, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::filter(sfbw <= 6 & sfbw > 0) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, sfbw)) -> sfbw_eyegroups_2
```

### All Sample, SF.Bandwidth by Eye_group, Mean +/- SEM

```{r sfbw_eyegroup_all_sample, warning = FALSE, fig.width = 8, fig.height = 5}
sfbw_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group, Eye_type) %>%
  dplyr::summarise(N = n(), Mean = mean(sfbw), Median = median(sfbw), SEM = sd(sfbw)/sqrt(n())) -> sfbw_eyegroup_all_sample_summary

sfbw_eyegroup_all_sample_summary %>%
  ggplot(aes(x = Eye_type, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("SF.Bandwidth, All Sample") +
  scale_y_continuous() +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

### All sample, SF.Bandwidth Violin + Boxplot by Eye_group

```{r sfbw_eyegroup_viobox, warning = FALSE, fig.width = 8, fig.height = 5}
sfbw_eyegroups_2 %>%
  ggplot(aes(x = Eye_type, y = sfbw, fill = Eye_manipulation)) +
  geom_violin(width = 1, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  scale_y_continuous() +
  xlab("") +
  ylab("SF.Bandwidth, All Sample") +
  scale_y_continuous(limits = c(0, 4)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black")) + 
  theme(legend.title = element_blank())
```

#### Summary of SF.Bandwidth by Eye_group, All Sample

```{r sfbw_eyegroup_all_sample_summary, warning = FALSE}
sfbw_eyegroup_all_sample_summary %>%
  dplyr::select(Eye_manipulation, Eye_group, Eye_type, Mean, SEM, N) %>%
  knitr::kable()
```

\pagebreak

#### Mixed Effects Model of SF.Bandwidth by Eye_group, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, interaction

Random effect(s): mouse_id

```{r sfbw_lmer_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_group * Eye_type + (1 | mouse_id), data = sfbw_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of SF.Bandwidth by Eye_group, between control and MD, All Sample

```{r sfbw_eyegroup_lmer_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

#### Mixed Effects Model of SF.Bandwidth by Eye_group, between control and MD (Binocular only), All Sample

```{r sfbw_lmer_all_sample_binocular, warning = FALSE}
sfbw_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF.Bandwidth by Eye_group, between control and MD (Monocular only), All Sample

```{r sfbw_lmer_all_sample_monocular, warning = FALSE}
sfbw_eyegroups_2 %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_type + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF.Bandwidth by Eye_group, between control and MD (Contra only), All Sample

```{r sfbw_lmer_all_sample_contra, warning = FALSE}
sfbw_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'contra') -> data_temp
model_lmer2 = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of SF.Bandwidth by Eye_group, between control and MD (Ipsi only), All Sample

```{r sfbw_lmer_all_sample_ipsi, warning = FALSE}
sfbw_eyegroups_2 %>%
  dplyr::filter(Eye_type == 'ipsi') -> data_temp
model_lmer2 = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
rm(data_temp, model_lmer2)
```

\pagebreak

#### T-test to Compare SF.Bandwidth by Eye_group, between control and MD, All Sample

```{r sfbw_eyegroup_ttest_all_sample, warning = FALSE}
compare_means(sfbw ~ Eye_manipulation, data =  sfbw_eyegroups_2, group.by = c("Eye_group", "Eye_type"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare SF.Bandwidth by Eye_group, between control and MD, All Sample

```{r sfbw_eyegroup_anova_all_sample, warning = FALSE}
print(summary(aov(sfbw ~ Eye_manipulation * Eye_group * Eye_type, data = sfbw_eyegroups_2)))
```

\pagebreak

### All Sample, SF.Bandwidth, Binocular vs. Monocular, Mean +/- SEM

```{r fig_sfbw_binmon_all_sample, warning = FALSE, fig.width = 5, fig.height = 4}
sfbw_eyegroups_2 %>%
  dplyr::group_by(Eye_manipulation, Eye_group) %>%
  dplyr::summarise(Mean = mean(sfbw), Median = median(sfbw), SEM = sd(sfbw)/sqrt(n()), N = n()) -> sfbw_binmon_all_sample_summary
  
y_max_value <- 3

sfbw_binmon_all_sample_summary %>%
  ggplot(aes(x = Eye_group, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  #facet_grid(~Eye_group, switch = "x", scales = "free_x", space = "free_x") +
  xlab("") +
  ylab("SF Bandwidth (octave)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/sfbw_bin_mon_all_sample.svg")
rm(y_max_value)
```

#### Summary of SF.Bandwidth, Binocular vs. Monocular, All Sample

```{r sfbw_binmon_all_sample_summary, warning = FALSE}
sfbw_binmon_all_sample_summary %>%
  knitr::kable()
```

#### Mixed Effects Model of SF.Bandwidth, Binocular vs. Monocular, between control and MD, All Sample

Fixed effect(s): Eye_manipulation, Eye_group, interaction

Random effect(s): mouse_id

```{r sfbw_lmer_binmon_all_sample, warning = FALSE}
model_lmer = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_group + (1 | mouse_id), data = sfbw_eyegroups_2, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of SF.Bandwidth, Binocular vs. Monocular, between control and MD, All Sample

```{r sfbw_eyegroup_lmer_binmon_all_sample_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

# Orientation Preferred, Count by Eye_group, All Sample

Selected only orientation-selective sample (CV: 0.5 - 1).

8 bins across 360 deg (O_pref values higher than 337.5 were included into the first bin centered at 0). 

```{r data_opref, warning = FALSE}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(OPref = as.numeric(OPref)) %>%
  dplyr::filter(CV >= 0.5 & CV <= 1) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, eye_type, OPref) %>%
  tidyr::spread(key = eye_type, value = OPref) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')
  ) %>%
  tidyr::gather(key = eye_type, value = OPref, ipsi, contra) %>%
  na.omit() %>%
  dplyr::mutate(Eye_manipulation = as.factor(eye_manipulation), Eye_group = as.factor(eye_group), Eye_type = as.factor(eye_type)) %>%
  dplyr::mutate(opref_new = OPref %% 337.5) %>%
  dplyr::rename(opref = opref_new) %>%
  dplyr::select(c(Eye_manipulation, mouse_id, field_id, cell_id, Eye_group, Eye_type, opref)) -> data_opref_2
```

### Control

```{r opref_control, warning = FALSE, fig.width = 10, fig.height = 6}
data_opref_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  dplyr::filter(Eye_manipulation == "control") %>%
  ggplot(aes(x = opref)) +
  facet_rep_wrap(~Eye_group_type, nrow = 2, scales = "free_y", repeat.tick.labels = "all", strip.position = "top") +
  geom_histogram(binwidth = 45, origin = -22.5, col = "white", fill = "blue") +
  scale_x_continuous(breaks = seq(0, 360, 45)) +
  theme_classic(base_size = 20) +
  labs(x = "Preferred Orientation (deg)", y = "Count - Control") +
  theme(axis.text = element_text(color = "black"))
```

### MD

```{r opref_MD, warning = FALSE, fig.width = 10, fig.height = 6}
data_opref_2 %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) %>%
  dplyr::filter(Eye_manipulation == "MD") %>%
  ggplot(aes(x = opref)) +
  facet_rep_wrap(~Eye_group_type, nrow = 2, scales = "free_y", repeat.tick.labels = "all", strip.position = "top") +
  geom_histogram(binwidth = 45, origin = -22.5, col = "white", fill = "red") +
  scale_x_continuous(breaks = seq(0, 360, 45)) +
  theme_classic(base_size = 20) +
  labs(x = "Preferred Orientation (deg)", y = "Count - Control") +
  theme(axis.text = element_text(color = "black"))
```

\pagebreak

# Peak SF Matching in Binocular Boutons

### Scatter Plot of Contra vs. Ipsi SF_peak, All Sample

Comparison is paired; Contra vs. Ipsi SF_peak for the same boutons.

```{r fig_sf_peak_scatter_contra_ipsi, warning = FALSE, fig.width = 10.5, fig.height = 5}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(SF = as.numeric(SF)) %>%
  dplyr::select(eye_manipulation, mouse_id, field_id, cell_id, SF, eye_type) %>%
  tidyr::spread(key = eye_type, value = SF) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) | is.na(ipsi) ~ 'Monocular',
                  TRUE ~ 'Binocular')) %>%
  dplyr::filter(eye_group == "Binocular") -> sf_match

# checking proportions add up to 1
sf_match %>%
  dplyr::left_join(dplyr::count(sf_match, eye_manipulation), by = "eye_manipulation") %>%
  dplyr::group_by(eye_manipulation, contra, ipsi, n) %>%
  dplyr::summarise(count = n()) %>%
  dplyr::mutate(N = n, proportion = count / n) %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::mutate(total_prop = sum(proportion)) -> sf_match_prop

point_sizes = round(seq(from = min(sf_match_prop$proportion), to = max(sf_match_prop$proportion), 
                        by = ((max(sf_match_prop$proportion) - min(sf_match_prop$proportion)) / 5)), digits = 2)

sf_match_prop %>%
  ggplot(aes(x = ipsi, y = contra, color = eye_manipulation)) + 
  geom_abline(linetype = "dashed", size = 1) +
  geom_point(aes(size = proportion, group = eye_manipulation)) +
  scale_size(name = "Proportion", breaks = point_sizes, labels = point_sizes) +
  labs(title = "", x = "Ipsi Peak SF (cpd)", y = "Contra Peak SF (cpd)") +
  facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "fixed", repeat.tick.labels = "all", strip.position = "top") +
  scale_x_log10(breaks = c(0.000001, sort(unique(data_tidy$SF)))) +
  scale_y_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_color_manual(values = c("blue", "red"), guide = 'none') +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA)) +
  theme(legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/sf_peak_scatter_contra_ipsi.svg")
rm(point_sizes)
```

\pagebreak

### SF Matching Group Percent Barplot, All Sample

SF-Matched: Contra SF_peak == Ipsi SF_peak

Contra-Acute: Contra SF_peak > Ipsi SF_peak

Ipsi-Acute: Contra SF_peak < Ipsi SF_peak

```{r sf_match_quant, warning = FALSE}
sf_match %>%
  dplyr::mutate(SF_match_group = dplyr::case_when(
    contra == ipsi ~ 'SF-Matched',
    contra > ipsi ~ 'Contra-Acute',
    ipsi > contra ~ 'Ipsi-Acute')
  ) -> sf_match_group

sf_match_group %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(TotalCount = n()) %>%
  dplyr::select(eye_manipulation, TotalCount) -> data_temp

sf_match_group %>%
  dplyr::group_by(eye_manipulation, SF_match_group) %>%
  dplyr::summarise(Count = n()) %>%
  dplyr::left_join(data_temp, by = 'eye_manipulation') %>%
  dplyr::mutate(Percent = Count / TotalCount * 100) -> sf_match_group_summary

rm(data_temp)

sf_match_group_summary %>%
  knitr::kable()
```

```{r fig_sf_match_barplot, warning = FALSE, fig.width = 5, fig.height = 3.5}
sf_match_group_summary %>%
  ggplot(aes(x = eye_manipulation, y = Percent, fill = SF_match_group)) +
  geom_bar(stat = "identity", width = 0.9, color = "black") +
  xlab("") +
  ylab("% Boutons") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.5)) +
  scale_fill_manual(values = c("darkorange2", "gold", "green3")) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) +  
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/sf_peak_match_group_barplot.svg")
```

### Chi-square Test to Compare SF Matching between control and MD, All Sample

```{r sf_match_chisq, warning = FALSE}
chisq.test(table(sf_match_group$SF_match_group, sf_match_group$eye_manipulation))
```

\pagebreak

### Summary of Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, All Sample

```{r sfpeak_match_quant, warning = FALSE}
sf_match %>%
  dplyr::mutate(SFPeak_diff = contra - ipsi) %>%
  dplyr::mutate(contra_log2 = log2(contra), ipsi_log2 = log2(ipsi)) %>%
  dplyr::mutate(SFPeak_diff_oct = contra_log2 - ipsi_log2) -> sfpeak_match_quant

sfpeak_match_quant %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N = n(), Mean = mean(SFPeak_diff_oct), Median = median(SFPeak_diff_oct), SEM = sd(SFPeak_diff_oct)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N, Mean, Median, SEM) -> sfpeak_match_quant_summary

sfpeak_match_quant_summary %>%
  knitr::kable()
```

\pagebreak

### Violin + Boxplot of Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, All Sample

```{r fig_sfpeak_match_quant_viobox, warning = FALSE, fig.width = 3, fig.height = 4.5}
y_max_value <- 1.4 * max(sfpeak_match_quant$SFPeak_diff_oct)
y_min_value <- min(sfpeak_match_quant$SFPeak_diff_oct)

sfpeak_match_quant %>%
  ggplot(aes(x = eye_manipulation, y = SFPeak_diff_oct, fill = eye_manipulation)) +
  geom_violin(width = 0.7, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  xlab("") +
  ylab("C-I Δ Peak SF (octave)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/sf_peak_diff_viobox.svg")
rm(y_max_value, y_min_value)
```

#### Wilcoxon Rank Sum Test to Compare Median Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, All Sample

```{r sfpeak_match_quant_ttest, warning = FALSE}
compare_means(SFPeak_diff_oct ~ eye_manipulation, data = sfpeak_match_quant, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

#### Mixed Effects Model of Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, All Sample

Fixed effect(s): Eye_manipulation

Random effect(s): mouse_id

```{r sfpeak_match_quant_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(SFPeak_diff_oct ~ eye_manipulation + (1 | mouse_id), data = sfpeak_match_quant, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, All Sample

```{r sfpeak_match_quant_lmer_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

### Mean Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, Mean +/- SEM By Animal

```{r fig_sfpeak_match_quant_by_animal, warning = FALSE, fig.width = 3, fig.height = 4.5}
sfpeak_match_quant %>%
  dplyr::group_by(eye_manipulation, mouse_id) %>%
  dplyr::summarise(N = n(), Mean = mean(SFPeak_diff_oct), Median = median(SFPeak_diff_oct), SEM = sd(SFPeak_diff_oct)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, mouse_id, N, Mean, Median, SEM) -> sfpeak_match_quant_by_animal

sfpeak_match_quant_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N_mea = n(), Mean_mea = mean(Mean), Median_mea = median(Mean), SD_mea = sd(Mean), SEM_mea = sd(Mean)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N_mea, Mean_mea, Median_mea, SEM_mea) -> sfpeak_match_quant_by_animal_mean_summary

y_max_value <- 1.4 * max(sfpeak_match_quant_by_animal$Mean)
y_min_value <- min(sfpeak_match_quant_by_animal$Mean)

sfpeak_match_quant_by_animal_mean_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean_mea, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean_mea - SEM_mea, ymax = Mean_mea + SEM_mea), width = 0.3, 
                position = position_dodge(0.9)) +
  xlab("") +
  ylab("Mean C-I Δ Peak SF (octave)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = sfpeak_match_quant_by_animal, aes(x = eye_manipulation, y = Mean), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(legend.position = "none")

ggsave("report_figures/sf_peak_diff_by_animal.svg")
rm(y_max_value, y_min_value)
```

#### T-test to Compare Mean Peak SF Difference (Contra - Ipsi, in octaves) in Binocular Boutons, between control and MD, By Animal

```{r sfpeak_match_quant_ttest_by_animal, warning = FALSE}
compare_means(Mean ~ eye_manipulation, data = sfpeak_match_quant_by_animal, method = "t.test", p.adjust.method = "none")
```

\pagebreak

# Preferred SF Matching in Binocular Boutons

### Scatter Plot of Contra vs. Ipsi Preferred SF in Binocular Boutons, between control and MD, All Sample

Selected only sample with SF.Pref between 0.03 and 0.96.

```{r fig_sfpref_match_scatter, warning = FALSE, fig.width = 9, fig.height = 5}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::filter(SF.Pref >= 0.03 & SF.Pref <= 0.96) %>%
  dplyr::mutate(SFPref = as.numeric(SF.Pref)) %>%
  dplyr::select(mouse_id, field_id, cell_id, eye_manipulation, eye_type, SFPref) %>%
  tidyr::spread(key = eye_type, value = SFPref) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) ~ 'Ipsi_Only',
                  is.na(ipsi) ~ 'Contra_Only',
                  TRUE ~ 'Binocular')) %>%
  dplyr::filter(eye_group == "Binocular") -> sfpref_match

sfpref_match %>%
  ggplot(aes(x = ipsi, y = contra, color = eye_manipulation)) + 
  geom_abline(linetype = "dashed", size = 1) +
  geom_point() +
  labs(title = "", x = "Ipsi Preferred SF (cpd)", y = "Contra Preferred SF (cpd)") +
  facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "fixed", repeat.tick.labels = "all", strip.position = "top") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_y_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_color_manual(values = c("blue", "red"), guide = 'none') +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA)) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/sf_pref_scatter_contra_ipsi.svg")
```

### Summary of Preferred SF Difference (in octaves) in Binocular Boutons, between control and MD, All Sample

```{r sfpref_match_quant, warning = FALSE}
sfpref_match %>%
  dplyr::mutate(SFPref_diff = contra - ipsi) %>%
  dplyr::mutate(contra_log2 = log2(contra), ipsi_log2 = log2(ipsi)) %>%
  dplyr::mutate(SFPref_diff_oct = contra_log2 - ipsi_log2) -> sfpref_match_quant

sfpref_match_quant %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N = n(), Mean = mean(SFPref_diff_oct), Median = median(SFPref_diff_oct), SEM = sd(SFPref_diff_oct)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N, Mean, Median, SEM) -> sfpref_match_quant_summary

sfpref_match_quant_summary %>%
  knitr::kable()
```

\pagebreak

### Violin + Boxplot of Preferred SF Difference (in octaves) in Binocular Boutons, between control and MD, All Sample

```{r fig_sfpref_match_quant_viobox, warning = FALSE, fig.width = 3, fig.height = 4.5}
y_max_value <- 1.4 * max(sfpref_match_quant$SFPref_diff_oct)
y_min_value <- min(sfpref_match_quant$SFPref_diff_oct)

sfpref_match_quant %>%
  ggplot(aes(x = eye_manipulation, y = SFPref_diff_oct, fill = eye_manipulation)) +
  geom_violin(width = 0.7, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  xlab("") +
  ylab("C-I Δ Preferred SF (octave)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/sf_pref_diff_viobox.svg")
rm(y_max_value, y_min_value)
```

#### Wilcoxon Rank Sum Test to Compare Median Pref SF Difference in Binocular Boutons, between control and MD, All Sample

```{r sfpref_match_quant_ttest, warning = FALSE}
compare_means(SFPref_diff_oct ~ eye_manipulation, data = sfpref_match_quant, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

#### Mixed Effects Model of Pref SF Difference in Binocular Boutons, between control and MD, All Sample

Fixed effect(s): Eye_manipulation

Random effect(s): mouse_id

```{r sfpref_match_quant_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(SFPref_diff_oct ~ eye_manipulation + (1 | mouse_id), data = sfpref_match_quant, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of Pref SF Difference in Binocular Boutons, between control and MD, All Sample

```{r sfpref_match_quant_lmer_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

### Median Pref SF Difference in Binocular Boutons, between control and MD, Mean +/- SEM By Animal

```{r fig_sfpref_match_quant_by_animal, warning = FALSE, fig.width = 3, fig.height = 4.5}
sfpref_match_quant %>%
  dplyr::group_by(eye_manipulation, mouse_id) %>%
  dplyr::summarise(N = n(), Mean = mean(SFPref_diff_oct), Median = median(SFPref_diff_oct), SEM = sd(SFPref_diff_oct)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, mouse_id, N, Mean, Median, SEM) -> sfpref_match_quant_by_animal

sfpref_match_quant_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N_med = n(), Mean_med = mean(Median), Median_med = median(Median), SD_med = sd(Median), SEM_med = sd(Median)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N_med, Mean_med, Median_med, SEM_med) -> sfpref_match_quant_by_animal_median_summary

y_max_value <- 1.2 * max(sfpref_match_quant_by_animal$Median)

sfpref_match_quant_by_animal_median_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean_med, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean_med - SEM_med, ymax = Mean_med + SEM_med), width = 0.3, 
                position = position_dodge(0.9)) +
  xlab("") +
  ylab("Median Δ Preferred SF (octave)") +
  scale_y_continuous() +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = sfpref_match_quant_by_animal, aes(x = eye_manipulation, y = Median), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(legend.position = "none")

ggsave("report_figures/sf_pref_diff_by_animal.svg")
rm(y_max_value)
```

#### Wilcoxon Rank Sum Test to Compare Median Pref SF Difference in Binocular Boutons, between control and MD, By Animal

```{r sfpref_match_quant_ttest_by_animal, warning = FALSE}
compare_means(Median ~ eye_manipulation, data = sfpref_match_quant_by_animal, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

# Orientation Matching in Binocular Boutons (following Wang et al., 2010 Neuron and Kirstie's method)

### Scatter Plot of Contra vs. Ipsi Preferred Orientation in Binocular Boutons, between control and MD, All Sample

```{r fig_opref_match_scatter, warning = FALSE, fig.width = 9, fig.height = 5}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(OPref = as.numeric(OPref)) %>%
  #dplyr::filter(CV >= 0.5 & CV <= 1) %>%
  dplyr::mutate(OPref_wang = dplyr::case_when(
     OPref > 180 ~ as.integer(OPref - 180),
     OPref <= 180 ~ as.integer(OPref)
     )) %>%
  dplyr::select(mouse_id, field_id, cell_id, eye_manipulation, eye_type, CV, OPref_wang) %>%
  dplyr::select(-CV) %>%
  tidyr::spread(key = eye_type, value = OPref_wang) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) ~ 'Ipsi_Only',
                  is.na(ipsi) ~ 'Contra_Only',
                  TRUE ~ 'Binocular')) %>%
  dplyr::filter(eye_group == "Binocular") -> opref_match_wang

opref_match_wang %>%
  ggplot(aes(x = ipsi, y = contra, color = eye_manipulation)) + 
  geom_abline(linetype = "dashed", size = 1) +
  geom_point() +
  labs(title = "", x = "Ipsi Preferred Ori (°)", y = "Contra Preferred Ori (°)") +
  facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "fixed", repeat.tick.labels = "all", strip.position = "top") +
  scale_x_continuous(breaks = seq(0, 180, 45)) +
  scale_y_continuous(breaks = seq(0, 180, 45)) +
  scale_color_manual(values = c("blue", "red"), guide = 'none') +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA)) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/opref_scatter_contra_ipsi.svg")
```

### Summary of OPref Difference in Binocular Boutons, between control and MD, All Sample

```{r opref_match_quant, warning = FALSE}
opref_match_wang %>%        # I modified from Kirstie's way
  dplyr::mutate(OPref_diff_abs = abs(ipsi - contra)) %>%
  dplyr::mutate(OPref_diff_lim = dplyr::case_when(
    OPref_diff_abs < 90 ~ as.integer(OPref_diff_abs),
    OPref_diff_abs >= 90 ~ as.integer(180 - OPref_diff_abs)
  )) -> opref_match_quant_wang 

opref_match_quant_wang %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N = n(), Mean = mean(OPref_diff_lim), Median = median(OPref_diff_lim), SEM = sd(OPref_diff_lim)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N, Mean, Median, SEM) -> opref_match_quant_wang_summary

opref_match_wang %>%         # Kirstie's way exactly
  dplyr::mutate(OPref_diff = contra - ipsi) %>%
  dplyr::mutate(OPref_diff_2 = dplyr::case_when(
    OPref_diff > 90 ~ as.integer(180 - OPref_diff),
    OPref_diff < -90 ~ as.integer(-180 - OPref_diff),
    TRUE ~ as.integer(OPref_diff))) %>%
  dplyr::mutate(OPref_diff_lim = abs(OPref_diff_2)) -> opref_match_quant_kirs

opref_match_quant_kirs %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N = n(), Mean = mean(OPref_diff_lim), Median = median(OPref_diff_lim), SEM = sd(OPref_diff_lim)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N, Mean, Median, SEM) -> opref_match_quant_kirs_summary

opref_match_quant_kirs_summary %>%
  knitr::kable()
```

\pagebreak

### Violin + Boxplot of OPref Difference in Binocular Boutons, between control and MD, All Sample

```{r fig_opref_match_quant_viobox, warning = FALSE, fig.width = 3, fig.height = 4.5}
y_max_value <- 110

opref_match_quant_kirs %>%
  ggplot(aes(x = eye_manipulation, y = OPref_diff_lim, fill = eye_manipulation)) +
  geom_violin(width = 0.7, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  xlab("") +
  ylab("Δ Preferred Ori (°)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value), breaks = seq(0, 90, 30)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/opref_diff_viobox.svg")
rm(y_max_value)
```

#### Wilcoxon Rank Sum Test to Compare Median OPref Difference in Binocular Boutons, between control and MD, All Sample

```{r opref_match_quant_ttest, warning = FALSE}
compare_means(OPref_diff_lim ~ eye_manipulation, data = opref_match_quant_kirs, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

#### Mixed Effects Model of OPref Difference in Binocular Boutons, between control and MD, All Sample

Fixed effect(s): Eye_manipulation

Random effect(s): mouse_id

```{r opref_match_quant_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(OPref_diff_lim ~ eye_manipulation + (1 | mouse_id), data = opref_match_quant_kirs, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of OPref Difference in Binocular Boutons, between control and MD, All Sample

```{r opref_match_quant_lmer_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

### Median OPref Difference in Binocular Boutons, between control and MD, Mean +/- SEM By Animal

```{r fig_opref_match_quant_kirs_by_animal, warning = FALSE, fig.width = 3, fig.height = 4.5}
opref_match_quant_kirs %>%
  dplyr::group_by(eye_manipulation, mouse_id) %>%
  dplyr::summarise(N = n(), Mean = mean(OPref_diff_lim), Median = median(OPref_diff_lim), SEM = sd(OPref_diff_lim)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, mouse_id, N, Mean, Median, SEM) -> opref_match_quant_kirs_by_animal

opref_match_quant_kirs_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N_med = n(), Mean_med = mean(Median), Median_med = median(Median), SD_med = sd(Median), SEM_med = sd(Median)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N_med, Mean_med, Median_med, SEM_med) -> opref_match_quant_kirs_by_animal_median_summary

y_max_value <- 1.1 * max(opref_match_quant_kirs_by_animal$Median)

opref_match_quant_kirs_by_animal_median_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean_med, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean_med - SEM_med, ymax = Mean_med + SEM_med), width = 0.3, 
                position = position_dodge(0.9)) +
  xlab("") +
  ylab("Median Δ Preferred Ori (°)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value), breaks = seq(0, 90, 30)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = opref_match_quant_kirs_by_animal, aes(x = eye_manipulation, y = Median), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(legend.position = "none")

ggsave("report_figures/opref_diff_by_animal.svg")
rm(y_max_value)
```

#### Wilcoxon Rank Sum Test to Compare Median OPref Difference in Binocular Boutons, between control and MD, By Animal

```{r opref_match_quant_ttest_by_animal, warning = FALSE}
compare_means(Median ~ eye_manipulation, data = opref_match_quant_kirs_by_animal, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

# RMax Matching in Binocular Boutons

### Scatter Plot of Contra vs. Ipsi RMax in Binocular Boutons, between control and MD, All Sample

```{r fig_rmax_match_scatter, warning = FALSE, fig.width = 9, fig.height = 5}
data_tidy %>%
  tidyr::spread(key = variable, value = value) %>%
  dplyr::filter(eye_type != 'both') %>%
  dplyr::mutate(RMax = as.numeric(RMax)) %>%
  dplyr::select(mouse_id, field_id, cell_id, eye_manipulation, eye_type, RMax) %>%
  tidyr::spread(key = eye_type, value = RMax) %>%
  dplyr::mutate(eye_group = dplyr::case_when(
                  is.na(contra) ~ 'Ipsi_Only',
                  is.na(ipsi) ~ 'Contra_Only',
                  TRUE ~ 'Binocular')) %>%
  dplyr::filter(eye_group == "Binocular") -> rmax_match

rmax_match %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(Mean_C = mean(contra), SEM_C = sd(contra)/sqrt(n()), N_C = n(), Mean_I = mean(ipsi), SEM_I = sd(ipsi)/sqrt(n()), N_I = n()) -> rmax_sum

rmax_match %>%
  ggplot(aes(x = ipsi, y = contra, color = eye_manipulation)) + 
  geom_abline(linetype = "dashed", size = 1) +
  geom_point(size = 1.25) +
  geom_point(data = rmax_sum, mapping = aes(x = Mean_I, y = Mean_C), size = 4, shape = 21, stroke = 1, color = "black") +
  #geom_errorbarh(data = rmax_sum, aes(xmin = (Mean_I - SEM_I), xmax = (Mean_I + SEM_I))) +
  labs(title = "", x = "Ipsi Response (ΔF / F0)", y = "Contra Response (ΔF / F0)") +
  facet_rep_wrap(~eye_manipulation, nrow = 1, scales = "fixed", repeat.tick.labels = "all", strip.position = "top") +
  scale_x_log10(breaks = c(0.01, 0.10, 1.00), limit = c(0.01, 1.00)) +
  scale_y_log10(breaks = c(0.01, 0.10, 1.00), limit = c(0.01, 1.00)) +
  scale_color_manual(values = c("blue", "red"), guide = 'none') +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA)) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line"))

ggsave("report_figures/rmax_scatter_contra_ipsi.svg")
```

### Summary of RMax Difference in Binocular Boutons, between control and MD, All Sample

```{r rmax_match_quant, warning = FALSE}
rmax_match %>%
  dplyr::mutate(RMax_diff = contra - ipsi) %>%
  dplyr::mutate(contra_log2 = log2(contra), ipsi_log2 = log2(ipsi)) %>%
  dplyr::mutate(RMax_diff_oct = contra_log2 - ipsi_log2) -> rmax_match_quant

rmax_match_quant %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N = n(), Mean = mean(RMax_diff_oct), Median = median(RMax_diff_oct), SEM = sd(RMax_diff_oct)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N, Mean, Median, SEM) -> rmax_match_quant_summary

rmax_match_quant_summary %>%
  knitr::kable()
```

\pagebreak

### Violin + Boxplot of RMax Difference in Binocular Boutons, between control and MD, All Sample

```{r fig_rmax_match_quant_viobox, warning = FALSE, fig.width = 3, fig.height = 4.5}
y_max_value <- 1.4 * max(rmax_match_quant$RMax_diff_oct)
y_min_value <- min(rmax_match_quant$RMax_diff_oct)

rmax_match_quant %>%
  ggplot(aes(x = eye_manipulation, y = RMax_diff_oct, fill = eye_manipulation)) +
  geom_violin(width = 0.7, position = position_dodge(width = 0.9), color = "black") +
  geom_boxplot(position = position_dodge(width = 0.9), alpha = 0, color = "black") +
  xlab("") +
  ylab("C-I Δ RMax (octave)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.position = "none")

ggsave("report_figures/rmax_diff_viobox.svg")
rm(y_max_value, y_min_value)
```

#### Wilcoxon Rank Sum Test to Compare Median RMax Difference in Binocular Boutons, between control and MD, All Sample

```{r rmax_match_quant_ttest, warning = FALSE}
compare_means(RMax_diff_oct ~ eye_manipulation, data = rmax_match_quant, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

#### Mixed Effects Model of RMax Difference in Binocular Boutons, between control and MD, All Sample

Fixed effect(s): Eye_manipulation

Random effect(s): mouse_id

```{r rmax_match_quant_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(RMax_diff_oct ~ eye_manipulation + (1 | mouse_id), data = rmax_match_quant, REML = FALSE)
print(anova(model_lmer))
```

#### Summary of Mixed Effects Model of RMax Difference in Binocular Boutons, between control and MD, All Sample

```{r rmax_match_quant_lmer_summary, warning = FALSE}
print(summary(model_lmer))
rm(model_lmer)
```

\pagebreak

### Median RMax Difference in Binocular Boutons, between control and MD, Mean +/- SEM By Animal

```{r fig_rmax_match_quant_by_animal, warning = FALSE, fig.width = 3, fig.height = 4.5}
rmax_match_quant %>%
  dplyr::group_by(eye_manipulation, mouse_id) %>%
  dplyr::summarise(N = n(), Mean = mean(RMax_diff_oct), Median = median(RMax_diff_oct), SEM = sd(RMax_diff_oct)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, mouse_id, N, Mean, Median, SEM) -> rmax_match_quant_by_animal

rmax_match_quant_by_animal %>%
  dplyr::group_by(eye_manipulation) %>%
  dplyr::summarise(N_med = n(), Mean_med = mean(Median), Median_med = median(Median), SD_med = sd(Median), SEM_med = sd(Median)/sqrt(n())) %>%
  dplyr::select(eye_manipulation, N_med, Mean_med, Median_med, SEM_med) -> rmax_match_quant_by_animal_median_summary

y_max_value <- 1.2 * max(rmax_match_quant_by_animal$Median)

rmax_match_quant_by_animal_median_summary %>%
  ggplot(aes(x = eye_manipulation, y = Mean_med, fill = eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean_med - SEM_med, ymax = Mean_med + SEM_med), width = 0.3, 
                position = position_dodge(0.9)) +
  xlab("") +
  ylab("Median Δ RMax (octave)") +
  scale_y_continuous() +
  scale_fill_manual(values = c("blue", "red")) +
  theme_classic(base_size = 20) +
  theme(panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside", 
        axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  geom_jitter(data = rmax_match_quant_by_animal, aes(x = eye_manipulation, y = Median), 
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 2) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(legend.position = "none")

ggsave("report_figures/rmax_diff_by_animal.svg")
rm(y_max_value)
```

#### Wilcoxon Rank Sum Test to Compare Median RMax Difference in Binocular Boutons, between control and MD, By Animal

```{r rmax_match_quant_ttest_by_animal, warning = FALSE}
compare_means(Median ~ eye_manipulation, data = rmax_match_quant_by_animal, method = "wilcox.test", p.adjust.method = "none")
```

\pagebreak

# By-SF RMax Analysis

### Scatter plot of SF_peak vs. RMax

```{r fig_sf_rmax, warning = FALSE, fig.width = 17, fig.height = 4.5}
labels <- c(Binocular_contra = "Binocular Contra", Binocular_ipsi = "Binocular Ipsi", Monocular_contra = "Contra Only", Monocular_ipsi = "Ipsi Only")
y_min_value <- 0.02
y_max_value <- 0.8

rmax_eyegroups_2 %>%
  dplyr::left_join(sf_peak_eyegroups_2) %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) -> data_sf_rmax

data_sf_rmax %>%
  dplyr::group_by(Eye_manipulation, Eye_group_type, SF.Peak) %>%
  dplyr::summarise(Mean = mean(rmax), SEM = sd(rmax)/sqrt(n()), N = n()) -> data_sf_rmax_summary

data_sf_rmax %>%
  ggplot(aes(x = SF.Peak, y = rmax, color = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group_type, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_color_manual(values = c("blue", "red")) +
  geom_jitter(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.1), size = 1, alpha = 0.3) +
  #geom_point(data = data_sf_rmax_summary, aes(x = SF.Peak, y = Mean, fill = Eye_manipulation), size = 3) +
  stat_smooth(data = data_sf_rmax_summary, aes(x = SF.Peak, y = Mean, fill = Eye_manipulation), size = 1.5, method = "loess") +
  stat_smooth(data = data_sf_rmax_summary, aes(x = SF.Peak, y = Mean - SEM, fill = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess") +
  stat_smooth(data = data_sf_rmax_summary, aes(x = SF.Peak, y = Mean + SEM, fill = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess") +
  #stat_smooth(method = "loess") +
  labs(x = "Peak Spatial Frequency (cpd)", y = "Response Amplitude (ΔF / F0)") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_rmax.svg")
rm(labels, y_min_value, y_max_value)
```

\pagebreak

### Mean +/- SEM of SF_peak (Binned) vs. RMax

```{r fig_sf_rmax_bar, warning = FALSE, fig.width = 17, fig.height = 4.5}
data_sf_rmax %>%
  dplyr::mutate(SF.Binned = dplyr::case_when(
    SF.Peak >= 0.03 & SF.Peak <= 0.06 ~ 'Low',
    SF.Peak >= 0.12 & SF.Peak <= 0.24 ~ 'Med',
    SF.Peak >= 0.48 & SF.Peak <= 0.96 ~ 'High')) -> data_sf_rmax_binned

data_sf_rmax_binned$SF.Binned2 <- reorder(data_sf_rmax_binned$SF.Binned, data_sf_rmax_binned$SF.Peak)

data_sf_rmax_binned %>%
  dplyr::group_by(Eye_manipulation, Eye_group_type, SF.Binned2) %>%
  dplyr::summarise(Mean = mean(rmax), SEM = sd(rmax)/sqrt(n()), N = n()) -> data_sf_rmax_binned_summary

labels <- c(Binocular_contra = "Binocular Contra", Binocular_ipsi = "Binocular Ipsi", Monocular_contra = "Contra Only", Monocular_ipsi = "Ipsi Only")
y_min_value <- 0
y_max_value <- 1.2 * max(data_sf_rmax_binned_summary$Mean + data_sf_rmax_binned_summary$SEM)

data_sf_rmax_binned_summary %>%
  ggplot(aes(x = SF.Binned2, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_rep_wrap(~Eye_group_type, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Peak Spatial Frequency", y = "Response Amplitude (ΔF / F0)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_rmax_binned_bar.svg")
rm(labels, y_min_value, y_max_value)
```

#### Boxplot of SF_peak (Binned) vs. RMax

```{r fig_sf_rmax_box, warning = FALSE, fig.width = 17, fig.height = 4.5}
labels <- c(Binocular_contra = "Binocular Contra", Binocular_ipsi = "Binocular Ipsi", Monocular_contra = "Contra Only", Monocular_ipsi = "Ipsi Only")
y_min_value <- 0.01
y_max_value <- 2

data_sf_rmax_binned %>%
  ggplot(aes(x = SF.Binned2, y = rmax, fill = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group_type, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_fill_manual(values = c("blue", "red")) +
  geom_boxplot(outlier.shape = NA, color = "black", size = 0.5) +
  labs(x = "Peak Spatial Frequency", y = "Response Amplitude (ΔF / F0)") +
  scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_rmax_binned_box.svg")
rm(labels, y_min_value, y_max_value)
```

\pagebreak

#### T-test to Compare RMax by SF_peak, between control and MD

```{r sf_rmax_test, warning = FALSE}
compare_means(rmax ~ Eye_manipulation, data = data_sf_rmax_binned, group.by = c("Eye_group", "Eye_type", "SF.Binned2"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare RMax by SF_peak, between control and MD

```{r sf_rmax_anova, warning = FALSE}
print(summary(aov(rmax ~ Eye_manipulation * Eye_group * Eye_type * SF.Binned2, data = data_sf_rmax_binned)))
```

\pagebreak

#### Mixed Effects Model of RMax by SF_peak

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, SF.Binned2, interaction

Random effect(s): mouse_id

```{r sf_rmax_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_group * Eye_type * SF.Binned2 + (1 | mouse_id), data = data_sf_rmax_binned, REML = FALSE)
print(anova(model_lmer))
```

#### MultComp Summary of Mixed Effects Model of RMax by SF_peak

```{r sf_rmax_lmer_summary, warning = FALSE}
print(summary(glht(model_lmer, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(model_lmer)
```

\pagebreak

### Scatter plot of SF_peak vs. RMax, Binocular vs. Monocular

```{r fig_sf_rmax_binmon, warning = FALSE, fig.width = 10, fig.height = 4.5}
y_min_value <- 0.02
y_max_value <- 0.8

data_sf_rmax %>%
  dplyr::group_by(Eye_manipulation, Eye_group, SF.Peak) %>%
  dplyr::summarise(Mean = mean(rmax), SEM = sd(rmax)/sqrt(n()), N = n()) -> data_sf_rmax_binmon_summary

data_sf_rmax %>%
  ggplot(aes(x = SF.Peak, y = rmax, color = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top") +
  scale_color_manual(values = c("blue", "red")) +
  geom_jitter(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.1), size = 1, alpha = 0.3) +
  stat_smooth(data = data_sf_rmax_binmon_summary, aes(x = SF.Peak, y = Mean - SEM, color = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess", se=F) +
  stat_smooth(data = data_sf_rmax_binmon_summary, aes(x = SF.Peak, y = Mean + SEM, color = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess", se=F) +
  stat_smooth(data = data_sf_rmax_binmon_summary, aes(x = SF.Peak, y = Mean, fill = Eye_manipulation), size = 1.5, method = "loess", se=F) +
  #stat_smooth(method = "loess") +
  labs(x = "Peak Spatial Frequency (cpd)", y = "Response Amplitude (ΔF / F0)") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  #scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_rmax_binmon.png")
rm(y_min_value, y_max_value)
```

\pagebreak

### Mean +/- SEM of SF_peak (Binned) vs. RMax, Binocular vs. Monocular

```{r fig_sf_rmax_bar_binmon, warning = FALSE, fig.width = 8, fig.height = 4.5}
data_sf_rmax_binned %>%
  dplyr::group_by(Eye_manipulation, Eye_group, SF.Binned2) %>%
  dplyr::summarise(Mean = mean(rmax), SEM = sd(rmax)/sqrt(n()), N = n()) -> data_sf_rmax_binned_binmon_summary

y_min_value <- 0
y_max_value <- 1.2 * max(data_sf_rmax_binned_binmon_summary$Mean + data_sf_rmax_binned_binmon_summary$SEM)

data_sf_rmax_binned_binmon_summary %>%
  ggplot(aes(x = SF.Binned2, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_rep_wrap(~Eye_group, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top") +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Peak Spatial Frequency", y = "Response Amplitude (ΔF / F0)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  #scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_rmax_binned_binmon_bar.svg")
rm(y_min_value, y_max_value)
```

#### Boxplot of SF_peak (Binned) vs. RMax, Binocular vs. Monocular

```{r fig_sf_rmax_box_binmon, warning = FALSE, fig.width = 8, fig.height = 4.5}
y_min_value <- 0.01
y_max_value <- 4

data_sf_rmax_binned %>%
  ggplot(aes(x = SF.Binned2, y = rmax, fill = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_fill_manual(values = c("blue", "red")) +
  geom_boxplot(outlier.shape = NA, color = "black", size = 0.5) +
  labs(x = "Peak Spatial Frequency", y = "Response Amplitude (ΔF / F0)") +
  #scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_rmax_binned_binmon_box.svg")
rm(y_min_value, y_max_value)
```

\pagebreak

#### T-test to Compare RMax by SF_peak (Binned), between control and MD, Binocular vs. Monocular

```{r sf_rmax_test_binmon, warning = FALSE}
compare_means(rmax ~ Eye_manipulation, data = data_sf_rmax_binned, group.by = c("Eye_group", "SF.Binned2"), method = "t.test", p.adjust.method = "none")
```

#### T-test to Compare RMax by SF_peak (Binned), Binocular vs. Monocular

```{r sf_rmax_test_binmon_2, warning = FALSE}
compare_means(rmax ~ SF.Binned2, data = data_sf_rmax_binned, group.by = c("Eye_group"), method = "t.test", p.adjust.method = "holm")
```

#### 3-way ANOVA to Compare RMax by SF_peak (Binned), Binocular vs. Monocular

```{r sf_rmax_anova_binmon, warning = FALSE}
print(summary(aov(rmax ~ Eye_manipulation * Eye_group * SF.Binned2, data = data_sf_rmax_binned)))
```

\pagebreak

#### Mixed Effects Model of RMax by SF_peak (Binned), Binocular vs. Monocular

Fixed effect(s): Eye_manipulation, Eye_group, SF.Binned2, interaction

Random effect(s): mouse_id

```{r sf_rmax_lmer_binmon, warning = FALSE}
model_lmer = lmerTest::lmer(rmax ~ Eye_manipulation * Eye_group * SF.Binned2 + (1 | mouse_id), data = data_sf_rmax_binned, REML = FALSE)
print(anova(model_lmer))
```

#### MultComp Summary of Mixed Effects Model of RMax by SF_peak (Binned), Binocular vs. Monocular

```{r sf_rmax_lmer_binmon_summary, warning = FALSE}
print(summary(glht(model_lmer, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(model_lmer)
```

\pagebreak

#### Mixed Effects Model of RMax by SF_peak (Binned), control vs. MD (Binocular only)

```{r sf_rmax_lmer_bin_only, warning = FALSE}
data_sf_rmax_binned %>%
  dplyr::filter(Eye_group == 'Binocular') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ Eye_manipulation * SF.Binned2 + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
```

#### MultComp Summary of Mixed Effects Model of RMax by SF_peak (Binned), control vs. MD (Binocular only)

```{r sf_rmax_lmer_bin_only_summary, warning = FALSE}
print(summary(glht(model_lmer2, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of RMax by SF_peak (Binned), control vs. MD, (Monocular only)

```{r sf_rmax_lmer_mon_only, warning = FALSE}
data_sf_rmax_binned %>%
  dplyr::filter(Eye_group == 'Monocular') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ Eye_manipulation * SF.Binned2 + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
```

#### MultComp Summary of Mixed Effects Model of RMax by SF_peak (Binned), control vs. MD, (Monocular only)

```{r sf_rmax_lmer_mon_only_summary, warning = FALSE}
print(summary(glht(model_lmer2, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(data_temp, model_lmer2)
```

\pagebreak

#### Mixed Effects Model of RMax by SF_peak (Binned), effect of SF group (Control only)

```{r sf_rmax_lmer_ctrl_only, warning = FALSE}
data_sf_rmax_binned %>%
  dplyr::filter(Eye_manipulation == 'control') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ SF.Binned2 + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
```

#### MultComp Summary of Mixed Effects Model of RMax by SF_peak (Binned), effect of SF group (Control only)

```{r sf_rmax_lmer_ctrl_only_summary, warning = FALSE}
print(summary(glht(model_lmer2, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(data_temp, model_lmer2)
```

#### Mixed Effects Model of RMax by SF_peak (Binned), effect of SF group (MD only)

```{r sf_rmax_lmer_md_only, warning = FALSE}
data_sf_rmax_binned %>%
  dplyr::filter(Eye_manipulation == 'MD') -> data_temp
model_lmer2 = lmerTest::lmer(rmax ~ SF.Binned2 + (1 | mouse_id), data = data_temp, REML = FALSE)
print(anova(model_lmer2))
```

#### MultComp Summary of Mixed Effects Model of RMax by SF_peak (Binned), effect of SF group (MD only)

```{r sf_rmax_lmer_md_only_summary, warning = FALSE}
print(summary(glht(model_lmer2, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(data_temp, model_lmer2)
```

\pagebreak

### Distribution of SF_peak (Binned), Binocular vs. Monocular

```{r fig_sfpeak_hist_all_sample, warning = FALSE, fig.width = 8, fig.height = 4.5}
data_sf_rmax_binned %>%
  dplyr::mutate(
    bin_01 = SF.Binned2 == "Low",
    bin_02 = SF.Binned2 == "Med",
    bin_03 = SF.Binned2 == "High"
  ) %>%
  dplyr::group_by(Eye_manipulation, Eye_group) %>%
  dplyr::summarise(
    low = sum(bin_01) / n() * 100,
    med = sum(bin_02) / n() * 100,
    high = sum(bin_03) / n() * 100
  ) %>%
  reshape2::melt(id.vars = c("Eye_manipulation", "Eye_group")) %>%
  dplyr::rename(sf_bin = variable, percent = value) -> sf_bin_hist

sf_bin_hist %>%
  dplyr::group_by(Eye_manipulation, Eye_group) %>%
  dplyr::summarise(totalPercent = sum(percent)) -> sf_bin_hist_check #all adds to 100%

y_max_value = 1.2 * max(sf_bin_hist$percent)

sf_bin_hist %>%
  ggplot(aes(x = sf_bin, y = percent, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  facet_rep_wrap(~Eye_group, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top") +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Peak Spatial Frequency", y = "% Boutons") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, y_max_value)) +
  scale_x_discrete(labels = c('Low', 'Med', 'High')) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_hist_binmon.svg")
rm(y_max_value)
```

#### Summary of Distribution of SF_peak (Binned), Binocular vs. Monocular

Distribution of SF_peak (Binned), Binocular vs. Monocular

```{r fig_sfpeak_hist_all_sample_summary, warning = FALSE}
sf_bin_hist %>%
  dplyr::select(Eye_manipulation, Eye_group, sf_bin, percent) %>%
  knitr::kable()
```

\pagebreak

# By-SF SF.Bandwidth Analysis

### Scatter plot of SF_peak vs. SF.Bandwidth

```{r fig_sf_sfbw, warning = FALSE, fig.width = 17, fig.height = 4.5}
labels <- c(Binocular_contra = "Binocular Contra", Binocular_ipsi = "Binocular Ipsi", Monocular_contra = "Contra Only", Monocular_ipsi = "Ipsi Only")
y_min_value <- 1.2
y_max_value <- 4.8

sfbw_eyegroups_2 %>%
  dplyr::left_join(sf_peak_eyegroups_2) %>%
  dplyr::mutate(Eye_group_type = paste(Eye_group, Eye_type, sep = "_")) -> data_sf_sfbw

data_sf_sfbw %>%
  dplyr::group_by(Eye_manipulation, Eye_group_type, SF.Peak) %>%
  dplyr::summarise(Mean = mean(sfbw), SEM = sd(sfbw)/sqrt(n()), N = n()) -> data_sf_sfbw_summary

data_sf_sfbw %>%
  ggplot(aes(x = SF.Peak, y = sfbw, color = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group_type, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_color_manual(values = c("blue", "red")) +
  geom_jitter(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.1), size = 1, alpha = 0.3) +
  #geom_point(data = data_sf_sfbw_summary, aes(x = SF.Peak, y = Mean, fill = Eye_manipulation), size = 3) +
  stat_smooth(data = data_sf_sfbw_summary, aes(x = SF.Peak, y = Mean, fill = Eye_manipulation), size = 1.5, method = "loess") +
  stat_smooth(data = data_sf_sfbw_summary, aes(x = SF.Peak, y = Mean - SEM, fill = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess") +
  stat_smooth(data = data_sf_sfbw_summary, aes(x = SF.Peak, y = Mean + SEM, fill = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess") +
  #stat_smooth(method = "loess") +
  labs(x = "Peak Spatial Frequency (cpd)", y = "SF Bandwidth (octave)") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  #scale_y_log10()
  scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_sfbw.svg")
rm(labels, y_min_value, y_max_value)
```

\pagebreak

### Mean +/- SEM of SF_peak (Binned) vs. SF.Bandwidth

```{r fig_sf_sfbw_bar, warning = FALSE, fig.width = 17, fig.height = 4.5}
data_sf_sfbw %>%
  dplyr::mutate(SF.Binned = dplyr::case_when(
    SF.Peak >= 0.03 & SF.Peak <= 0.06 ~ 'Low',
    SF.Peak >= 0.12 & SF.Peak <= 0.24 ~ 'Med',
    SF.Peak >= 0.48 & SF.Peak <= 0.96 ~ 'High')) -> data_sf_sfbw_binned

data_sf_sfbw_binned$SF.Binned2 <- reorder(data_sf_sfbw_binned$SF.Binned, data_sf_sfbw_binned$SF.Peak)

data_sf_sfbw_binned %>%
  dplyr::group_by(Eye_manipulation, Eye_group_type, SF.Binned2) %>%
  dplyr::summarise(Mean = mean(sfbw), SEM = sd(sfbw)/sqrt(n()), N = n()) -> data_sf_sfbw_binned_summary

labels <- c(Binocular_contra = "Binocular Contra", Binocular_ipsi = "Binocular Ipsi", Monocular_contra = "Contra Only", Monocular_ipsi = "Ipsi Only")
y_min_value <- 0
y_max_value <- 1.2 * max(data_sf_sfbw_binned_summary$Mean + data_sf_sfbw_binned_summary$SEM)

data_sf_sfbw_binned_summary %>%
  ggplot(aes(x = SF.Binned2, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_rep_wrap(~Eye_group_type, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top", labeller = labeller(Eye_group_type = labels)) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Peak Spatial Frequency", y = "SF Bandwidth (octave)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_sfbw_binned_bar.svg")
rm(labels, y_min_value, y_max_value)
```

\pagebreak

#### T-test to Compare SF.Bandwidth by SF_peak, between control and MD

```{r sf_sfbw_test, warning = FALSE}
compare_means(sfbw ~ Eye_manipulation, data = data_sf_sfbw_binned, group.by = c("Eye_group", "Eye_type", "SF.Binned2"), method = "t.test", p.adjust.method = "none")
```

#### 3-way ANOVA to Compare SF.Bandwidth by SF_peak, between control and MD

```{r sf_sfbw_anova, warning = FALSE}
print(summary(aov(sfbw ~ Eye_manipulation * Eye_group * Eye_type * SF.Binned2, data = data_sf_sfbw_binned)))
```

\pagebreak

#### Mixed Effects Model of SF.Bandwidth by SF_peak

Fixed effect(s): Eye_manipulation, Eye_group, Eye_type, SF.Binned2, interaction

Random effect(s): mouse_id

```{r sf_sfbw_lmer, warning = FALSE}
model_lmer = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_group * Eye_type * SF.Binned2 + (1 | mouse_id), data = data_sf_sfbw_binned, REML = FALSE)
print(anova(model_lmer))
```

#### MultComp Summary of Mixed Effects Model of SF.Bandwidth by SF_peak

```{r sf_sfbw_lmer_summary, warning = FALSE}
print(summary(glht(model_lmer, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(model_lmer)
```

\pagebreak

### Scatter plot of SF_peak vs. SF.Bandwidth, Binocular vs. Monocular

```{r fig_sf_sfbw_binmon, warning = FALSE, fig.width = 10, fig.height = 4.5}
y_min_value <- 1.2
y_max_value <- 4.8

data_sf_sfbw %>%
  dplyr::group_by(Eye_manipulation, Eye_group, SF.Peak) %>%
  dplyr::summarise(Mean = mean(sfbw), SEM = sd(sfbw)/sqrt(n()), N = n()) -> data_sf_sfbw_binmon_summary

data_sf_sfbw %>%
  ggplot(aes(x = SF.Peak, y = sfbw, color = Eye_manipulation)) +
  facet_rep_wrap(~Eye_group, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top") +
  scale_color_manual(values = c("blue", "red")) +
  geom_jitter(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.1), size = 1, alpha = 0.3) +
  stat_smooth(data = data_sf_sfbw_binmon_summary, aes(x = SF.Peak, y = Mean - SEM, color = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess", se=F) +
  stat_smooth(data = data_sf_sfbw_binmon_summary, aes(x = SF.Peak, y = Mean + SEM, color = Eye_manipulation), size = 0.5, alpha = 0.1, method = "loess", se=F) +
  stat_smooth(data = data_sf_sfbw_binmon_summary, aes(x = SF.Peak, y = Mean, fill = Eye_manipulation), size = 1.5, method = "loess", se=F) +
  #stat_smooth(method = "loess") +
  labs(x = "Peak Spatial Frequency (cpd)", y = "SF Bandwidth (octave)") +
  scale_x_log10(breaks = sort(unique(data_tidy$SF))) +
  #scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_sfbw_binmon.png")
rm(y_min_value, y_max_value)
```

\pagebreak

### Mean +/- SEM of SF_peak (Binned) vs. SF.Bandwidth, Binocular vs. Monocular

```{r fig_sf_sfbw_bar_binmon, warning = FALSE, fig.width = 8, fig.height = 4.5}
data_sf_sfbw_binned %>%
  dplyr::group_by(Eye_manipulation, Eye_group, SF.Binned2) %>%
  dplyr::summarise(Mean = mean(sfbw), SEM = sd(sfbw)/sqrt(n()), N = n()) -> data_sf_sfbw_binned_binmon_summary

y_min_value <- 0
y_max_value <- 1.2 * max(data_sf_sfbw_binned_binmon_summary$Mean + data_sf_sfbw_binned_binmon_summary$SEM)

data_sf_sfbw_binned_binmon_summary %>%
  ggplot(aes(x = SF.Binned2, y = Mean, fill = Eye_manipulation)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SEM, ymax = Mean + SEM), width = 0.3, 
                position = position_dodge(0.9)) +
  facet_rep_wrap(~Eye_group, nrow = 1, scales = "fixed", repeat.tick.labels = FALSE, strip.position = "top") +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Peak Spatial Frequency", y = "SF Bandwidth (octave)") +
  scale_y_continuous(limits = c(y_min_value, y_max_value)) +
  #scale_y_log10(limits = c(y_min_value, y_max_value)) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_text(color = "black"), axis.ticks = element_line(color = "black")) + 
  theme(legend.title = element_blank(), legend.spacing.x = unit(0.2, 'cm'), legend.key.height = unit(1.5, "line")) +
  theme(axis.text = element_text(color = "black"), panel.border = element_rect(fill = NA, colour = NA)) +
  theme(strip.text.x = element_text(size = 20, color = "black")) +
  theme(strip.background = element_rect(colour = NA, fill = NA))

ggsave("report_figures/sf_peak_sfbw_binned_binmon_bar.svg")
rm(y_min_value, y_max_value)
```

\pagebreak

#### T-test to Compare SF.Bandwidth by SF_peak (Binned), between control and MD, Binocular vs. Monocular

```{r sf_sfbw_test_binmon, warning = FALSE}
compare_means(sfbw ~ Eye_manipulation, data = data_sf_sfbw_binned, group.by = c("Eye_group", "SF.Binned2"), method = "t.test", p.adjust.method = "none")
```

#### T-test to Compare SF.Bandwidth by SF_peak (Binned), Binocular vs. Monocular

```{r sf_sfbw_test_binmon_2, warning = FALSE}
compare_means(sfbw ~ SF.Binned2, data = data_sf_sfbw_binned, group.by = c("Eye_group"), method = "t.test", p.adjust.method = "holm")
```

#### 3-way ANOVA to Compare SF.Bandwidth by SF_peak (Binned), Binocular vs. Monocular

```{r sf_sfbw_anova_binmon, warning = FALSE}
print(summary(aov(sfbw ~ Eye_manipulation * Eye_group * SF.Binned2, data = data_sf_sfbw_binned)))
```

\pagebreak

#### Mixed Effects Model of SF.Bandwidth by SF_peak (Binned), Binocular vs. Monocular

Fixed effect(s): Eye_manipulation, Eye_group, SF.Binned2, interaction

Random effect(s): mouse_id

```{r sf_sfbw_lmer_binmon, warning = FALSE}
model_lmer = lmerTest::lmer(sfbw ~ Eye_manipulation * Eye_group * SF.Binned2 + (1 | mouse_id), data = data_sf_sfbw_binned, REML = FALSE)
print(anova(model_lmer))
```

#### MultComp Summary of Mixed Effects Model of SF.Bandwidth by SF_peak (Binned), Binocular vs. Monocular

```{r sf_sfbw_lmer_binmon_summary, warning = FALSE}
print(summary(glht(model_lmer, linfct = mcp(SF.Binned2 = "Tukey"))))
rm(model_lmer)
```
